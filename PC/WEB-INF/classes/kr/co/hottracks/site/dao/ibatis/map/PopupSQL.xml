<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="PopupSQL">
    <typeAlias alias="popupParam" type="kr.co.hottracks.site.model.backoffice.PopupParam"/>
    <typeAlias alias="mdPickParam" type="kr.co.hottracks.site.model.backoffice.MdPickParam"/>    
    <typeAlias alias="popupCriteria" type="kr.co.hottracks.site.model.backoffice.PopupCriteria"/>
    <typeAlias alias="popupListData" type="kr.co.hottracks.site.model.backoffice.PopupListData"/>

	<insert id="insertPopup" parameterClass="popupParam">
        <selectKey keyProperty="popupseq" resultClass="int">
            SELECT popup_seq.nextval popupseq FROM DUAL
        </selectKey>
		insert into TB_POPUP_MASTER
					(   
						POPUP_SEQ
						, MNGR_MD_ID
						, POPUP_TITLE
						, DISP_START_DT
						, DISP_END_DT
						, CTGR_ID
						, LAYER_EXPS_YN
						, DISP_YN
						, POPUP_SIZE_X
						, POPUP_SIZE_Y
						, POPUP_POS_X
						, POPUP_POS_Y
						, IMAGE_URL
						, REGST_DTM
						, POPUP_HTML
						, REGST_ADMIN_ID
						, DISP_GBN
						, BRAND_ID
						, EVENT_ID
						, TODAY_CLOSE_YN
					)
					values
					(
						  #popupseq#
						, #mngrmdid#
						, #popuptitle#
						, #dispstartdt#
						, #dispenddt#
						, #selectCategoryID#
						, #layerexpsyn#
						, #dispyn#
						, #popupsizex#
						, #popupsizey#
						, #popupposx#
						, #popupposy#
						, #imageurl#
						, sysdate
						, #popuphtml#
						, #regstadminid#
						, #dispgbn#
						, #brandId#
						, #eventid#
						, #todaycloseyn#
					)
	</insert>
    
    <insert id="insertMallPopup" parameterClass="popupParam">
        INSERT INTO tb_mall_popup
        (
            mall_id
          , popup_seq
        )
        VALUES
        (
            #mallId#
          , #popupseq#
        )
    </insert>
    
    <delete id="deleteMallPopup" parameterClass="popupParam">
        DELETE FROM tb_mall_popup
         WHERE popup_seq = #popupseq#
    </delete>
	
	<update id="updatePopup" parameterClass="popupParam">
		update TB_POPUP_MASTER
		   set MNGR_MD_ID = #mngrmdid#
			, POPUP_TITLE = #popuptitle#
			, DISP_START_DT = #dispstartdt#
			, DISP_END_DT = #dispenddt#
			, CTGR_ID = #selectCategoryID#
			, LAYER_EXPS_YN = #layerexpsyn#
			, POPUP_SIZE_X = #popupsizex#
			, POPUP_SIZE_Y = #popupsizey#
			, POPUP_POS_X = #popupposx#
			, POPUP_POS_Y = #popupposy#
			, IMAGE_URL = #imageurl#
			, REGST_DTM = sysdate
			, POPUP_HTML = #popuphtml#
			, REGST_ADMIN_ID = #regstadminid#
			, DISP_GBN = #dispgbn#
			, BRAND_ID = #brandId#
			, EVENT_ID = #eventid#
			, TODAY_CLOSE_YN = #todaycloseyn#
		 where POPUP_SEQ = #popupseq#
	</update>	
	
	<update id="setDispYn" parameterClass="popupCriteria">
		update TB_POPUP_MASTER
		   set DISP_YN = #dispYn#
		 where POPUP_SEQ = #popupseq#
	</update>
	
	
    <select id="getPopupList" parameterClass="popupCriteria" resultClass="popupParam" >
        SELECT  A.POPUP_SEQ         as popupseq
              , A.POPUP_TITLE       as popuptitle
              , A.LAYER_EXPS_YN     as layerexpsyn
              , A.DISP_YN           as dispyn
              , A.POPUP_SIZE_X      as popupsizex
              , A.POPUP_SIZE_Y      as popupposy
              , A.POPUP_POS_X       as popupposx
              , A.POPUP_POS_Y       as popupposy
              , A.IMAGE_URL         as imageurl
              , A.POPUP_HTML        as popuphtml
              , A.REGST_ADMIN_ID    as regstadminid
              , A.DISP_START_DT     as dispstartdt
              , A.DISP_END_DT       as dispenddt
              , A.REGST_DTM         as regstdtm
              , A.DISP_GBN          as dispgbn
              , (select C.ADMIN_NAME from TB_ADMIN C where A.MNGR_MD_ID = C.ADMIN_ID) as mngrmdid
              , (select D.CTGR_NAME from TB_CATEGORY D where D.CTGR_ID = A.CTGR_ID) selectCategoryID
              , FC_GET_MALLID_POPUP(A.POPUP_SEQ) as mallId
          FROM  TB_POPUP_MASTER A
         WHERE  A.POPUP_TITLE like '%' || #popuptitle# || '%'
           AND  A.POPUP_SEQ IN (SELECT B.popup_seq FROM tb_mall_popup B WHERE B.mall_id IN ($mallIdUsingSql$))
			<isNotEmpty property="beginRegistDate" prepend="AND">
				to_char(A.REGST_DTM,'yyyymmdd') >= #beginRegistDate#
			</isNotEmpty>
			<isNotEmpty property="endRegistDate" prepend="AND">
				to_char(A.REGST_DTM,'yyyymmdd') <![CDATA[<]]>= #endRegistDate#
			</isNotEmpty>
			<isNotEmpty property="selDispYn" prepend="AND">
				A.DISP_YN = #selDispYn#
			</isNotEmpty>
         ORDER BY A.POPUP_SEQ desc
    </select> 
    
    <select id="setListCount" parameterClass="popupCriteria" resultClass="int" >
        SELECT  COUNT(A.POPUP_SEQ)
          FROM  TB_POPUP_MASTER A
         WHERE  A.POPUP_TITLE like '%' || #popuptitle# || '%'
           AND  A.POPUP_SEQ IN (SELECT B.popup_seq FROM tb_mall_popup B WHERE B.mall_id IN ($mallIdUsingSql$))
        <isNotEmpty property="beginRegistDate" prepend="AND">
            to_char(A.REGST_DTM,'yyyymmdd') >= #beginRegistDate#
        </isNotEmpty>
        <isNotEmpty property="endRegistDate" prepend="AND">
            to_char(A.REGST_DTM,'yyyymmdd') <![CDATA[<]]>= #endRegistDate#
        </isNotEmpty>
        <isNotEmpty property="selDispYn" prepend="AND">
            A.DISP_YN = #selDispYn#
        </isNotEmpty>
    </select>
    
    <select id="getPopup" parameterClass="popupParam" resultClass="popupParam" >
        SELECT  POPUP_SEQ       as popupseq
              , MNGR_MD_ID      as mngrmdid
              , POPUP_TITLE     as popuptitle
              , DISP_START_DT   as dispstartdt
              , DISP_END_DT     as dispenddt
              , CTGR_ID         as selectCategoryID
              , LAYER_EXPS_YN   as layerexpsyn
              , DISP_YN         as dispyn
              , POPUP_SIZE_X    as popupsizex
              , POPUP_SIZE_Y    as popupsizey
              , POPUP_POS_X     as popupposx
              , POPUP_POS_Y     as popupposy
              , IMAGE_URL       as imageurl
              , REGST_DTM       as regstdtm
              , POPUP_HTML      as popuphtml
              , REGST_ADMIN_ID  as regstadminid
              , (CASE WHEN FC_GET_MALLID_POPUP(a.popup_seq) = '00' THEN A.brand_id
                      WHEN FC_GET_MALLID_BRAND(A.brand_id) = '00' THEN A.brand_id
                      WHEN FC_GET_MALLID_BRAND(A.brand_id) = FC_GET_MALLID_POPUP(a.popup_seq) THEN A.brand_id
                      ELSE NULL
                  END ) AS brandId
              , (case when DISP_GBN in ('B','D','T') then 'B' else DISP_GBN end)    as dispgbn
              , (SELECT brand_name 
                   FROM tb_brand B
                  WHERE B.brand_id = A.brand_id
                )   as brandNm
              , (SELECT B.event_id
                   FROM tb_event_master B
                  WHERE B.event_id = A.event_id
                    AND FC_IS_VALID_EVENT_NO_DATECHECK(B.event_id, FC_GET_MALLID_EVENT(B.event_id)) = 'Y'
                )   as eventid
              , TODAY_CLOSE_YN  as todaycloseyn
              , (case when DISP_GBN in ('B','T') then '1' end)  as brandMain
              , (case when DISP_GBN in ('D','T') then '2' end)  as brandDetail
              , FC_GET_MALLID_POPUP(A.POPUP_SEQ) as mallId
          FROM  TB_POPUP_MASTER A
         WHERE  POPUP_SEQ = #popupseq#
    </select>

    <select id="selectPopupListForFront" resultClass="popupListData" parameterClass="popupListData">
        SELECT  A.popup_seq       popupSeq
              , A.mngr_md_id      mngrMdId
              , A.popup_title     popupTitle
              , A.disp_start_dt   dispStartDt
              , A.disp_end_dt     dispEndDt
              , A.ctgr_id         ctgrId
              , A.layer_exps_yn   layerExpsYn
              , A.disp_yn         dispYn
              , A.popup_size_x    popupSizeX
              , A.popup_size_y    popupSizeY
              , A.popup_pos_x     popupPosX
              , A.popup_pos_y     popupPosY
              , A.image_url       imageUrl
              , A.regst_dtm       regstDtm
              , A.popup_html      popupHtml
              , A.regst_admin_id  regstAdminId
              , A.disp_gbn        dispGbn
              , A.brand_id        brandId
              , A.event_id        eventId
              , A.today_close_yn  todayCloseYn
          FROM  tb_popup_master A
              , tb_mall_popup B
         WHERE  A.popup_seq = B.popup_seq
           AND  B.mall_id = #mallId#
           AND  TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.disp_start_dt AND A.disp_end_dt
           AND  A.disp_yn = 'Y'
         <isEqual property="dispGbn" compareValue="G" prepend="AND">
                (A.disp_gbn = #dispGbn# OR A.disp_gbn = 'A')
         </isEqual>
         <isEqual property="dispGbn" compareValue="O" prepend="AND">
                (A.disp_gbn = #dispGbn# OR A.disp_gbn = 'A')
         </isEqual>
         <isEqual property="dispGbn" compareValue="C" prepend="AND">
                A.disp_gbn = #dispGbn#
           AND  LENGTH(A.ctgr_id) = 6
           AND  A.ctgr_id = #ctgrId#
           AND  A.ctgr_id IN (SELECT C.ctgr_id FROM tb_mall_category C WHERE C.mall_id = #mallId#)
         </isEqual>
         <isEqual property="dispGbn" compareValue="E" prepend="AND">
                A.disp_gbn = #dispGbn#
           AND  ((A.event_id = #eventId# AND A.event_id IN (SELECT C.event_id FROM tb_mall_event C WHERE C.mall_id = #mallId#)) 
                 OR A.event_id IS NULL )
         </isEqual>
         <isEqual property="dispGbn" compareValue="B" prepend="AND">
                (A.disp_gbn = #dispGbn# OR A.disp_gbn = 'T')
         </isEqual>
         <isEqual property="dispGbn" compareValue="D" prepend="AND">
                (A.disp_gbn = #dispGbn# OR A.disp_gbn = 'T')
           AND  ((A.brand_id = #brandId# AND A.brand_id IN (SELECT C.brand_id from tb_mall_brand C WHERE C.mall_id = #mallId#)) 
                 OR A.brand_id IS NULL)
         </isEqual>
         <isEqual property="dispGbn" compareValue="W" prepend="AND">
                A.disp_gbn = #dispGbn#
         </isEqual>
         <isEqual property="dispGbn" compareValue="R" prepend="AND">
                A.disp_gbn = #dispGbn#
         </isEqual>
         <isEqual property="dispGbn" compareValue="V" prepend="AND">
                A.disp_gbn = #dispGbn#
         </isEqual>
         <isEqual property="dispGbn" compareValue="M" prepend="AND">
                A.disp_gbn = #dispGbn#
         </isEqual>
    </select>
    
    <select id="selectPopupForFront" parameterClass="popupParam" resultClass="popupParam" >
        SELECT  POPUP_SEQ       as popupseq
              , MNGR_MD_ID      as mngrmdid
              , POPUP_TITLE     as popuptitle
              , DISP_START_DT   as dispstartdt
              , DISP_END_DT     as dispenddt
              , CTGR_ID         as selectCategoryID
              , LAYER_EXPS_YN   as layerexpsyn
              , DISP_YN         as dispyn
              , POPUP_SIZE_X    as popupsizex
              , POPUP_SIZE_Y    as popupsizey
              , POPUP_POS_X     as popupposx
              , POPUP_POS_Y     as popupposy
              , IMAGE_URL       as imageurl
              , REGST_DTM       as regstdtm
              , POPUP_HTML      as popuphtml
              , REGST_ADMIN_ID  as regstadminid
              , A.BRAND_ID      as brandId
              , (case when DISP_GBN in ('B','D','T') then 'B' else DISP_GBN end)    as dispgbn
              , (SELECT brand_name FROM tb_brand C WHERE A.brand_id = C.brand_id)   as brandNm
              , A.event_id      as eventid
              , TODAY_CLOSE_YN  as todaycloseyn
              , (case when DISP_GBN in ('B','T') then '1' end)  as brandMain
              , (case when DISP_GBN in ('D','T') then '2' end)  as brandDetail
          FROM  tb_popup_master A
         WHERE  A.popup_seq = #popupseq#
    </select>
    
    <delete id="mdPickDelete" parameterClass="mdPickParam">
		delete from TB_CATEGORY_DISPLAY_ENTITY
		 where DISP_MSTR_ID = #pickGbn#
		   and CTGR_ID = #selectCategoryID#
		   and MALL_ID = #mallId#
    </delete>

    <insert id="mdPickInsert" parameterClass="mdPickParam">
		insert into TB_CATEGORY_DISPLAY_ENTITY (DISP_ORDER, CTGR_ID, DISP_MSTR_ID, DGR, DISP_ETT_GBN, SELL_PRDT_BCODE, BRAND_ID, EVENT_ID, DISP_YN, BNR_SEQ, DISP_ETT_SEQ, MALL_ID)
		(select #productListSeqSingle# DISP_ORDER
		      , #selectCategoryID# CTGR_ID
		      , #pickGbn# DISP_MSTR_ID
		      , 2 DGR
		      , 'P' DISP_ETT_GBN
		      , #productListIdSingle# SELL_PRDT_BCODE
		      , '' BRAND_ID
		      , '' EVENT_ID
		      , 'Y' DISP_YN
		      , '' BNR_SEQ
		      , DISP_ETT_SEQ.nextval DISP_ETT_SEQ
		      , #mallId# MALL_ID
		   from dual)   
    </insert>    
    
    <select id="mdPickSelect" parameterClass="mdPickParam" resultClass="mdPickParam" >
		select A.SELL_PRDT_BCODE  productId
		     , (select C.PRDT_IMAGE_URL from TB_PRODUCT_IMAGE C where C.SELL_PRDT_BCODE = A.SELL_PRDT_BCODE and C.DISP_ORDER = 0) imageUrl
		     , B.PRDT_NAME        productNm
		     , B.PRDT_SELL_PRICE  productSaleAmt
		     , B.PRDT_DSCNT_PRICE     productDcAmt
		     , A.DISP_ORDER       productListSeqSingle
		  from TB_CATEGORY_DISPLAY_ENTITY A
		     , TB_SELL_PRODUCT B
		 where A.DISP_MSTR_ID = #pickGbn#
		   and A.CTGR_ID = #selectCategoryID#
		   and A.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE
		   and A.MALL_ID = #mallId#
		 order by A.DISP_ORDER
    </select>
    
    <select id="getCallSaveNum" resultClass="String" >
		select 'H' || trim(to_char(to_number(nvl(max(substr(KEYCODE,2,19)),0)) + 1,'0000000000000000000')) keyCode 
		  from TB_PHONESAVENUM
    </select>
    
    <insert id="saveCallCon" parameterClass="mdPickParam">
        insert into TB_PHONESAVENUM (KEYCODE, CUSTNAME, CUSTPHONE, CUSTORDER, CUSTJUMIN)
                             values (
                                        #keyCode#
                                      , #custNm#
                                      , #callNum#
                                      , #orderNum#
                                      , #custJumin#
                                    )   
    </insert>
    
    <insert id="saveCallCon2" parameterClass="mdPickParam">
        insert into TB_PHONESAVENUM (KEYCODE, CUSTNAME, CUSTPHONE, CUSTORDER, CUSTJUMIN, CUSTCONTEXT, CALLID, REGDT, CALLGUBUN1, CALLGUBUN2)
                             values ( 
                                      #keyCode#
                                    , #callCustName#
                                    , #callPhoneNumber#
                                    , #callOrderNumber#
                                    , #callCustId#
                                    , #callContext#
                                    , #callId#
                                    , sysdate
                                    , #callGubun#
                                    , #callGubun2#
                                    )   
    </insert>
        
        
    <insert id="imageUploadSave" parameterClass="mdPickParam">
		insert into TB_IMAGE_UPLOAD  (SEQNO, IMAGE_NAME, IMAGE_URL, REG_DTM)
		  (select nvl(max(SEQNO),0) + 1
		        , #callCustName#
		        , #imageUrl#
		        , sysdate
		     from TB_IMAGE_UPLOAD)    
    </insert>
    
    <select id="imageUploadSearch" parameterClass="mdPickParam" resultClass="mdPickParam" >
		select SEQNO      callNum
		     , IMAGE_NAME custNm
		     , IMAGE_URL  imageUrl
		  from TB_IMAGE_UPLOAD  
		 where to_char(REG_DTM,'yyyymmdd') between #sDt# and #eDt#
		   and IMAGE_NAME like '%' || trim(#callCustName#) || '%'
		 order by SEQNO desc
    </select>    

    <procedure id="btnTrans" parameterClass="String">
        { call PR_BTNTRANS(#returnSeq#) }
    </procedure>
</sqlMap>
