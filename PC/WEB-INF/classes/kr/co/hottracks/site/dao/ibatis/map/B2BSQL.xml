<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="B2BSQL">
    <typeAlias alias="b2bCounsel" type="kr.co.hottracks.site.model.common.b2b.B2BCounsel"/>
    <typeAlias alias="sellGiftExt" type="kr.co.hottracks.site.model.common.sellGift.SellGiftExt"/>
    <typeAlias alias="btobParam" type="kr.co.hottracks.site.model.frontoffice.order.BtobParam"/>
    
    <!--
        작성자 : 장진용
        작성일 : 2011.09.06
        기능 : B2B 상담요청 내용을 입력한다
    -->
    <insert id="insertB2BCounsel" parameterClass="b2bCounsel">
        <selectKey keyProperty="b2bCnslSeq" resultClass="int" type="pre">SELECT B2B_CNSL_SEQ.NEXTVAL FROM DUAL</selectKey>
        INSERT INTO TB_B2B_COUNSEL (B2B_CNSL_SEQ, COMP_NAME, MNGR_NAME, MNGR_TEL_NUM, REGST_DTM)
        VALUES(#b2bCnslSeq#, #compName#, #mngrName#, #mngrTelNum#, sysdate)
    </insert>
    
    <select id="getCateList" parameterClass="String" resultClass="sellGiftExt">
        select CATE_NUM     ctgrId
             , CATE_NAME    ctgrName
          from TB_BTOB_CATE
         where BTOBURL = #value#
         order by CATE_NUM
    </select>
    
    <select id="getCateProductList" parameterClass="String" resultClass="sellGiftExt">
        select A.CATE_NUM                       ctgrId
             , A.SELL_PRDT_BCODE                sellPrdtBcode
             , B.PRDT_NAME                      prdtName
             , B.PRDT_SELL_PRICE                prdtSellPrice
             , FC_GET_CPN_PRICE(A.SELL_PRDT_BCODE, '02')            lastCpnPrice
             , (SELECT T.PRDT_IMAGE_URL FROM TB_PRODUCT_IMAGE T WHERE T.SELL_PRDT_BCODE = A.SELL_PRDT_BCODE AND T.DISP_ORDER = 0)  productImageUrl
             , (SELECT T.PRDT_IMAGE_URL FROM TB_PRODUCT_IMAGE T WHERE T.SELL_PRDT_BCODE = A.SELL_PRDT_BCODE AND T.DISP_ORDER = 1)  productImageUrl2
          from TB_BTOB_CATE_PRODUCT A
          join TB_SELL_PRODUCT B on A.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE 
         where A.BTOBURL = #value#
         order by A.CATE_NUM 
    </select>
    
    <insert id="insertOrder" parameterClass="btobParam">
        insert into TB_BTOB_ORDER ( BTOBURL     , USER_NUM  , ORDER_NUM     , ORDER_STAT    , ORD_NAME
                                  , ORD_TEL     , ORD_HP    , ORD_ZIPCOD    , ORD_ADDR1     , ORD_ADDR2
                                  , ORD_MEMO    , REGDT)
                           values ( #btoburl#   , #userNum# , #orderNum#    , 'C1411'       , #ordName#
                                  , #ordTel#    , #ordHp#   , #ordZipcod#   , #ordAddr1#    , #ordAddr2#
                                  , #ordMemo#   , sysdate)
    </insert>
    
    <insert id="insertOrderProduct" parameterClass="btobParam">
        insert into TB_BTOB_ORDER_PRODUCT ( BTOBURL     , USER_NUM      , ORDER_NUM 
                                          , ORDER_SEQ 
                                          , SELL_PRDT_BCODE
                                          , ORDER_QTY   , ORDER_STAT    , DELI_AMT
                                          , REGDT)
                                   values ( #btoburl#     , #userNum#      , #orderNum# 
                                          , (select nvl(max(ORDER_SEQ),0) + 1 from TB_BTOB_ORDER_PRODUCT where BTOBURL = #btoburl# and USER_NUM = #userNum# and ORDER_NUM = #orderNum#) 
                                          , #sellPrdtBcode#
                                          , #orderQty#    , 'C1411'        , FC_GET_CPN_PRICE(#sellPrdtBcode#, '02')     
                                          , sysdate)
    </insert>

    <select id="getordList" parameterClass="btobParam" resultClass="btobParam">
        select to_char(A.REGDT,'yyyy-mm-dd')    ordDt
             , A.BTOBURL                        btoburl
             , A.ORDER_NUM                      orderNum
             , A.USER_NUM                       userNum
             , (select SA.USER_ID from TB_USER SA where SA.USER_NUM = A.USER_NUM)   userId
             , A.ORD_NAME                       ordName
             , (select count(SA.SELL_PRDT_BCODE) 
                  from TB_BTOB_ORDER_PRODUCT SA 
                 where SA.BTOBURL = A.BTOBURL 
                   and SA.USER_NUM = A.USER_NUM 
                   and SA.ORDER_NUM = A.ORDER_NUM) prdtCnt
             , (select sum(SA.ORDER_QTY) 
                  from TB_BTOB_ORDER_PRODUCT SA 
                 where SA.BTOBURL = A.BTOBURL 
                   and SA.USER_NUM = A.USER_NUM 
                   and SA.ORDER_NUM = A.ORDER_NUM) orderQty
             , (select sum(SA.DELI_AMT * SA.ORDER_QTY) 
                  from TB_BTOB_ORDER_PRODUCT SA 
                 where SA.BTOBURL = A.BTOBURL 
                   and SA.USER_NUM = A.USER_NUM 
                   and SA.ORDER_NUM = A.ORDER_NUM) ordAmt
             , A.ORDER_STAT                     orderStat
             , FC_GET_CODE_NAME(A.ORDER_STAT)   orderStatNm             
          from TB_BTOB_ORDER A
         where A.BTOBURL = #btoburl#
           and A.USER_NUM = #userNum#
    </select>
</sqlMap>