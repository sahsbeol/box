<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="IdolChartSQL">
    <typeAlias alias="IdolChart" type="kr.co.hottracks.site.model.common.disp.IdolChart"/>
    <typeAlias alias="IdolChartProductExt" type="kr.co.hottracks.site.model.common.disp.IdolchartProductExt"/>
    
    <!--  
        작성자: 권동희
        작성일 : 2019.03.11
        기능 : 아이돌차트 리스트 반환
    -->
    <select id="getIdoleChartList" parameterClass="IdolChart" resultClass="IdolChart">
        /* IdolChartSQL.getIdoleChartList */
        select I.GUBUN         gubun
             , I.CNTID         cntid
             , I.TITLE         title
             , I.LINK          link
             , I.IMAGE         image
             , I.CATEGORY      category
             , I.AUTHOR        author
             , I.GUID          guid
             , I.PUBDATE       pubdate
             , (CASE WHEN TO_CHAR(PUBDT,'YYYYMMDD') =TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '오늘 ' || TO_CHAR(PUBDT,'HH24:MI:SS') 
                ELSE TO_CHAR(PUBDT,'YYYY.MM.DD') END)            pubdt
             , I.REGDT         regdt
             , I.UPDDT         upddt
             , I.DISP_YN       dispYn
             , I.HIT           hit
          FROM TB_IDOLCHART I
         WHERE DISP_YN='Y'
           AND TITLE NOT LIKE '%주차 GOOD&amp;BAD%'
        <isNotEmpty property="gubun">
           AND GUBUN = #gubun#
        </isNotEmpty>
        <isNotEmpty property="cntid">
           AND CNTID = #cntid#
        </isNotEmpty>
         ORDER BY I.pubdate DESC
    </select>
    
    
    <!--  
        작성자: 권동희
        작성일 : 2019.03.11
        기능 : 아이돌차트 리스트 반환
    -->
    <select id="getIdoleChart" parameterClass="IdolChart" resultClass="IdolChart">
        /* IdolChartSQL.getIdoleChart */
        select GUBUN         gubun
             , CNTID         cntid
             , TITLE         title
             , LINK          link
             , IMAGE         image
             , replace(replace(replace(description, '기사 제보 및 제휴 news@idol-chart.com','')
                               ,'저작권자 ⓒ 아이돌차트 무단 전재 및 재배포 금지','')
                               ,'text-align: left','text-align: center')   description
             , CATEGORY      category
             , AUTHOR        author
             , GUID          guid
             , PUBDATE       pubdate
             , (CASE WHEN TO_CHAR(PUBDT,'YYYYMMDD') =TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '오늘 ' || TO_CHAR(PUBDT,'HH24:MI:SS') 
                ELSE TO_CHAR(PUBDT,'YYYY.MM.DD') END)            pubdt
             , REGDT         regdt
             , UPDDT         upddt
             , DISP_YN       dispYn
             , HIT           hit
          FROM TB_IDOLCHART I
         WHERE DISP_YN='Y'
           AND TITLE NOT LIKE '%주차 GOOD&amp;BAD%'
        <isNotEmpty property="gubun">
           AND GUBUN = #gubun#
        </isNotEmpty>
        <isNotEmpty property="cntid">
           AND CNTID = #cntid#
        </isNotEmpty>
         ORDER BY I.pubdate DESC
    </select>
    
    
    <!--  
        작성자: 권동희
        작성일 : 2019.03.11
        기능 : 아이돌차트 건수 반환
    -->
    <select id="countIdoleChartList" parameterClass="IdolChart" resultClass="Integer">
        /* IdolChartSQL.countIdoleChartList */
        select count(*)
          FROM TB_IDOLCHART
         WHERE DISP_YN='Y'
           AND TITLE NOT LIKE '%주차 GOOD&amp;BAD%'
        <isNotEmpty property="gubun">
           AND GUBUN = #gubun#
        </isNotEmpty>
        <isNotEmpty property="cntid">
           AND CNTID = #cntid#
        </isNotEmpty>
         ORDER BY pubdt DESC
    </select>
    
    <!--  
        작성자: 권동희
        작성일 : 2019.03.11
        기능 : 아이돌차트 조회수 세팅
    -->
    <update id="updateIdolHit" parameterClass="IdolChart">
        /* IdolChartSQL.updateIdolHit */
        MERGE INTO TB_IDOLCHART_HIT H
        USING DUAL ON (H.DT = TO_CHAR(SYSDATE, 'YYYYMMDD') AND H.CNTID  = #cntid# AND H.GUBUN ='P')
        WHEN MATCHED THEN
                UPDATE SET H.HIT = H.HIT+1
        WHEN NOT MATCHED THEN
                INSERT (H.DT, H.CNTID, H.GUBUN, H.HIT)
                VALUES (TO_CHAR(SYSDATE, 'YYYYMMDD'),#cntid# ,'P', 1)
   </update>
       
    <!--  
        작성자: 권동희
        작성일 : 2019.03.11
        기능 : 아이돌차트 연관상품 리스트 
    -->   
   <select id="getIdolChartProductList" parameterClass="IdolChart" resultClass="IdolChartProductExt">
        /* IdolChartSQL.getIdolChartProductList */
        select A.SELL_PRDT_BCODE                                        sellPrdtBcode
             , FC_GET_BRAND_NAME(B.BRAND_ID,'Y')                        brandName
             , FC_GET_PRDT_NAME(A.SELL_PRDT_BCODE , '02')               prdtName
             , B.PRDT_SELL_PRICE                                        prdtSellPrice
             , B.RCRD_CD                                                rcrdCd
             , B.SELL_PRDT_GBN                                          sellPrdtGbn
             , B.NYO_SELL_BAN_YN                                        nyoSellBanYn
             , B.PRDT_STAT_CODE                                         prdtStatCode
             , C.ARTI_NAME                                              artiName
             , FC_GET_PRODUCT_IMAGE_URL(A.SELL_PRDT_BCODE)              productImageUrl
             , FC_GET_PRODUCT_IMAGE_URL2(A.SELL_PRDT_BCODE)             productImageUrl2
             , FC_GET_CPN_PRICE(A.SELL_PRDT_BCODE, '02')                lastCpnPrice
             , B.DLVY_VNDR_ID                                           dlvyVndrId
             , FC_GET_WISH_PRODUCT_COUNT(B.SELL_PRDT_BCODE, '02')       wishPrdtCnt
             , FC_GET_PRODUCT_ICON_CODE(B.SELL_PRDT_BCODE, '02')        prdtIcon
             , FC_GET_REVIEW_PRODUCT_COUNT(B.SELL_PRDT_BCODE, '02')     reviewCount
             , C.RTNG_CODE                                              rtngCode
             , PC.CTGR_ID                                               ctgrId
             , B.PRDT_SELL_PRICE                                        basePrdtSellPrice
         FROM TB_IDOLCHART_PRODUCT A
         JOIN TB_SELL_PRODUCT B ON A.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE AND B.PRMT_CODE = 'C0302' AND B.PRDT_STAT_CODE IN ('C0312', 'C0313')
         JOIN TB_PRODUCT_CATEGORY PC ON A.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE AND PC.STD_CTGR_YN='Y'
         JOIN TB_BRAND D ON B.BRAND_ID = D.BRAND_ID
        LEFT JOIN TB_RECORD C ON B.SELL_PRDT_BCODE = C.SELL_PRDT_BCODE
        WHERE 1=1
        <isNotEmpty property="gubun">
          AND GUBUN = #gubun#
        </isNotEmpty>
        <isNotEmpty property="cntid">
          AND CNTID = #cntid#
        </isNotEmpty>
        ORDER BY A.DISP_ORDER 
    </select>
       
</sqlMap>
