<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RankingSQL">
    <typeAlias alias="category" type="kr.co.hottracks.site.model.common.category.Category"/>
    <typeAlias alias="cateDispEntity" type="kr.co.hottracks.site.model.common.display.CateDispEntity"/>
    <typeAlias alias="rankingParam" type="kr.co.hottracks.site.model.backoffice.RankingParam"/>
    <typeAlias alias="searchKeywordData" type="kr.co.hottracks.site.model.frontoffice.search.SearchKeywordData"/>
    
    <select id="getRankingCategory" parameterClass="map" resultClass="category">
        SELECT C.CTGR_ID cateId
               , MC.MALL_ID mallId
        FROM   TB_CATEGORY C, TB_MALL_CATEGORY MC
        WHERE  C.CTGR_ID = MC.CTGR_ID
               AND MC.MALL_ID = #mallId#
               AND LENGTH(C.CTGR_ID) <![CDATA[ <= ]]> #cateIdLength#
               AND C.CTGR_ID NOT IN ('00', 'XXXX') 
               AND C.USE_YN = 'Y'
    </select>
    
    <select id="getProductRankingBestSeller" parameterClass="map" resultClass="cateDispEntity">
        SELECT SELL_PRDT_BCODE sellPrdtBcode
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'P' dispEttGbn
               , 'Y' dispYn
          FROM (SELECT SELL_PRDT_BCODE
                       , CNT
                  FROM (SELECT DECODE(SP.SELL_PRDT_GBN, 'S', FC_GET_BARCODE(OP.SELL_PRDT_BCODE), OP.SELL_PRDT_BCODE) SELL_PRDT_BCODE
                               , COUNT(*) CNT
                          FROM TB_ORDER_PRODUCT OP
                               , TB_ORDER O
                               , TB_PRODUCT_CATEGORY PC
                               , TB_SELL_PRODUCT SP
                               , TB_VENDOR_CONTRACT VC
                         WHERE OP.ORDER_NUM = O.ORDER_NUM
                               AND TO_CHAR(O.ORDER_DTM, 'YYYY/MM/DD') BETWEEN TO_CHAR(SYSDATE - 7, 'YYYY/MM/DD') AND TO_CHAR(SYSDATE - 1, 'YYYY/MM/DD')
                               <!--AND TO_CHAR(O.ORDER_DTM, 'YYYY/MM/DD') BETWEEN '2011/04/01' AND '2011/04/27'-->
                               AND OP.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE
                               AND PC.STD_CTGR_YN = 'Y'
                               AND PC.CTGR_ID LIKE #cateId# || '%'
                               AND OP.SELL_PRDT_BCODE = SP.SELL_PRDT_BCODE
                               AND SP.PRMT_CODE = 'C0302'
                               AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                               AND FC_IS_VALID_PRODUCT(SP.SELL_PRDT_BCODE, #mallId#) = 'Y'
                               AND SP.VNDR_CNTRT_ID = VC.VNDR_CNTRT_ID
                               AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                               AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
                      GROUP BY DECODE(SP.SELL_PRDT_GBN, 'S', FC_GET_BARCODE(OP.SELL_PRDT_BCODE), OP.SELL_PRDT_BCODE)
                       )
              ORDER BY CNT DESC
               )
         WHERE ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>
    
    <select id="getProductRankingLowPrice" parameterClass="map" resultClass="cateDispEntity">
        SELECT SELL_PRDT_BCODE sellPrdtBcode
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'P' dispEttGbn
               , 'Y' dispYn
        FROM  (SELECT    SP.SELL_PRDT_BCODE
               FROM      TB_SELL_PRODUCT SP
                         , TB_PRODUCT_CATEGORY PC
                         , TB_VENDOR_CONTRACT VC
               WHERE     SP.PRMT_CODE = 'C0302'
                         AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                         AND SP.SELL_PRDT_GBN in ('P', 'G')
                         AND FC_IS_VALID_PRODUCT(SP.SELL_PRDT_BCODE, #mallId#) = 'Y'
                         AND SP.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE
                         AND PC.STD_CTGR_YN = 'Y'
                         AND PC.CTGR_ID LIKE #cateId# || '%'
                         AND SP.VNDR_CNTRT_ID = VC.VNDR_CNTRT_ID
                         AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                         AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
               ORDER BY  SP.PRDT_DSCNT_RATE DESC)
        WHERE  ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>
    
    <select id="getProductRankingRecentProduct" parameterClass="map" resultClass="cateDispEntity">
        SELECT SELL_PRDT_BCODE sellPrdtBcode
             , #cateId# ctgrId
             , #dispMstrId# dispMstrId
             , #mallId# mallId
             , ROWNUM dispOrder
             , 'P' dispEttGbn
             , 'Y' dispYn
          FROM (SELECT SP.SELL_PRDT_BCODE
                  FROM TB_SELL_PRODUCT SP
                     , TB_PRODUCT_CATEGORY PC
                     , TB_VENDOR_CONTRACT VC
                 WHERE SP.PRMT_CODE = 'C0302'
                   AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                   AND SP.SELL_PRDT_GBN in ('P', 'G')
                   AND FC_IS_VALID_PRODUCT(SP.SELL_PRDT_BCODE, #mallId#) = 'Y'
                   AND SP.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE
                   AND PC.CTGR_ID LIKE  #cateId# || '%'
                   AND SP.VNDR_CNTRT_ID = VC.VNDR_CNTRT_ID
                   AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                   AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
                   AND SP.PRMT_DTM IS NOT NULL
                 group by SP.SELL_PRDT_BCODE, SP.PRMT_DTM
                 ORDER BY SP.PRMT_DTM DESC)
         WHERE ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>
    
    <select id="getProductRankingCustomer" parameterClass="map" resultClass="cateDispEntity">
        SELECT   SELL_PRDT_BCODE sellPrdtBcode
                 , #cateId# ctgrId
                 , #dispMstrId# dispMstrId
                 , #mallId# mallId
                 , ROWNUM dispOrder
                 , 'P' dispEttGbn
                 , 'Y' dispYn
        FROM    (SELECT   SELL_PRDT_BCODE
                 FROM    (SELECT   SELL_PRDT_BCODE
                                  , SUM(SUM_PRDT_GRADE)/COUNT(*) GRADE_AVG
                                  , PRMT_DTM
                          FROM    (SELECT   PQ.SELL_PRDT_BCODE
                                            , PQ.ASK_REGST_USER_NUM
                                            , SUM(PQ.PRDT_GRADE) SUM_PRDT_GRADE
                                            , SP.PRMT_DTM
                                   FROM     TB_PRODUCT_QNA PQ
                                            , TB_SELL_PRODUCT SP
                                            , TB_PRODUCT_CATEGORY PC
                                            , TB_VENDOR_CONTRACT VC
                                   WHERE    PQ.PRDT_ARTCL_GBN = 'C'
                                            AND PQ.SELL_PRDT_BCODE = SP.SELL_PRDT_BCODE
                                            AND SP.PRMT_CODE = 'C0302'
                                            AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                                            AND SP.SELL_PRDT_GBN in ('P', 'G')
                                            AND FC_IS_VALID_PRODUCT(SP.SELL_PRDT_BCODE, #mallId#) = 'Y'
                                            AND SP.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE
                                            AND PC.STD_CTGR_YN = 'Y'
                                            AND PC.CTGR_ID LIKE #cateId# || '%'
                                            AND SP.VNDR_CNTRT_ID = VC.VNDR_CNTRT_ID
                                            AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                                            AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
                                            AND SP.PRMT_DTM IS NOT NULL
                                   GROUP BY PQ.SELL_PRDT_BCODE, PQ.ASK_REGST_USER_NUM, SP.PRMT_DTM
                                   )
                          GROUP BY SELL_PRDT_BCODE, PRMT_DTM
                          HAVING   COUNT(*) <![CDATA[ > ]]> 2)
                 ORDER BY GRADE_AVG DESC, PRMT_DTM DESC)
        WHERE    ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getProductRankingPopular" parameterClass="map" resultClass="cateDispEntity">    
        SELECT  SELL_PRDT_BCODE sellPrdtBcode
                , #cateId# ctgrId
                , #dispMstrId# dispMstrId
                , #mallId# mallId
                , ROWNUM dispOrder
                , 'P' dispEttGbn
                , 'Y' dispYn
        FROM   (SELECT    /*+USE_HASH(WP,SP,PC,VC)*/
                          WP.SELL_PRDT_BCODE
                FROM      TB_WISH_PRODUCT WP
                          , TB_SELL_PRODUCT SP
                          , TB_PRODUCT_CATEGORY PC
                          , TB_VENDOR_CONTRACT VC
                WHERE     WP.WISH_GBN = 'P'
                          AND WP.SELL_PRDT_BCODE = SP.SELL_PRDT_BCODE
                          AND SP.PRMT_CODE = 'C0302'
                          AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                          AND SP.SELL_PRDT_GBN in ('P', 'G')
                          AND FC_IS_VALID_PRODUCT(SP.SELL_PRDT_BCODE, #mallId#) = 'Y'
                          AND WP.SELL_PRDT_BCODE = PC.SELL_PRDT_BCODE
                          AND PC.STD_CTGR_YN = 'Y'
                          AND PC.CTGR_ID LIKE #cateId# || '%'
                          AND SP.VNDR_CNTRT_ID = VC.VNDR_CNTRT_ID
                          AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                          AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
                GROUP BY  WP.SELL_PRDT_BCODE
                ORDER BY  COUNT(*) DESC)
        WHERE   ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getEventRankingHotEvent" parameterClass="map" resultClass="cateDispEntity">
        SELECT EVENT_ID eventId
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'E' dispEttGbn
               , 'Y' dispYn
        FROM  (SELECT   EM.EVENT_ID
               FROM     TB_EVENT_MASTER EM
                        , TB_EVENT_SELL_PRODUCT ESP
                        , TB_ORDER_PRODUCT OP
                        , TB_MALL_EVENT ME
               WHERE    EM.EVENT_ID = ESP.EVENT_ID
                        AND ESP.SELL_PRDT_BCODE = OP.SELL_PRDT_BCODE
                        AND EM.DISP_YN = 'Y'
                        AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN EM.EVENT_START_DT AND EM.EVENT_END_DT
                        AND EM.EVENT_STAT_CODE = 'C0181'
                        AND EM.EVENT_TYPE_CODE not in ('C0196', 'C0198')
                        AND EM.PRMT_CODE = 'C0374'
                        AND EM.CTGR_ID LIKE #cateId# || '%'
                        AND EM.EVENT_ID = ME.EVENT_ID
                        AND ME.MALL_ID = #mallId#
               GROUP BY EM.EVENT_ID
               ORDER BY COUNT(*) DESC)
        WHERE ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getEventRankingNewEvent" parameterClass="map" resultClass="cateDispEntity">
        SELECT EVENT_ID eventId
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'E' dispEttGbn
               , 'Y' dispYn
        FROM  (SELECT   EM.EVENT_ID
               FROM     TB_EVENT_MASTER EM
                        , TB_MALL_EVENT ME
               WHERE    EM.DISP_YN = 'Y'
                        AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN EM.EVENT_START_DT AND EM.EVENT_END_DT
                        AND EM.EVENT_STAT_CODE = 'C0181'
                        AND EM.PRMT_CODE = 'C0374'
                        AND EM.CTGR_ID LIKE #cateId# || '%'
                        AND EM.EVENT_ID = ME.EVENT_ID
                  AND ME.MALL_ID = #mallId#
               ORDER BY EM.EVENT_START_DT DESC)
        WHERE  ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getEventRankingHotBrand" parameterClass="map" resultClass="cateDispEntity">
        SELECT BRAND_ID brandId
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'B' dispEttGbn
               , 'Y' dispYn
        FROM  (SELECT   B.BRAND_ID
               FROM     TB_ORDER_PRODUCT OP
                        , TB_SELL_PRODUCT SP
                        , TB_BRAND B
                        , TB_MALL_BRAND MB
               WHERE    OP.SELL_PRDT_BCODE = SP.SELL_PRDT_BCODE
                        AND SP.BRAND_ID = B.BRAND_ID
                        AND B.DISP_CTGR_ID LIKE #cateId# || '%'
                        AND B.BRAND_ID = MB.BRAND_ID
                        AND MB.MALL_ID = #mallId#
               GROUP BY B.BRAND_ID
               ORDER BY COUNT(*) DESC)
        WHERE  ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getEventRankingNewBrand" parameterClass="map" resultClass="cateDispEntity">
        SELECT BRAND_ID brandId
               , #cateId# ctgrId
               , #dispMstrId# dispMstrId
               , #mallId# mallId
               , ROWNUM dispOrder
               , 'B' dispEttGbn
               , 'Y' dispYn
        FROM   (SELECT   B.BRAND_ID
                         , B.REGST_DTM
                FROM     TB_VENDOR_CONTRACT VC
                         , TB_BRAND B
                         , TB_MALL_BRAND MB
                WHERE    EXISTS(SELECT 1 
                                  FROM TB_SELL_PRODUCT SP
                                 WHERE VC.VNDR_CNTRT_ID = SP.VNDR_CNTRT_ID
                                       AND SP.PRMT_CODE = 'C0302'
                                       AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                                       AND SP.SELL_PRDT_GBN in ('P', 'G'))
                         AND VC.BRAND_ID = B.BRAND_ID
                         AND VC.VNDR_CNTRT_STAT_CODE = 'C0072'
                         AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VC.CNTRT_START_DT AND VC.CNTRT_END_DT
                         AND B.DISP_CTGR_ID LIKE #cateId# || '%'
                         AND B.BRAND_ID = MB.BRAND_ID
                         AND MB.MALL_ID = #mallId#
                GROUP BY B.BRAND_ID, B.REGST_DTM
                ORDER BY B.REGST_DTM DESC
        )
        WHERE  ROWNUM <![CDATA[ < ]]> #dataSize#
    </select>

    <select id="getMaxDgr" parameterClass="map" resultClass="int">
        SELECT  NVL(MAX(DGR), 0) 
          FROM  TB_CATEGORY_DISPLAY_ENTITY 
         WHERE  DISP_MSTR_ID = #dispMstrId#
                AND MALL_ID = #mallId#
    </select>

    <delete id="deleteRankingForBestSeller" parameterClass="map">
       DELETE FROM  TB_CATEGORY_DISPLAY_ENTITY 
       WHERE        DISP_MSTR_ID = #dispMstrId# 
                    AND DGR NOT IN (#newDgr#, #beforeDgr#)
                    AND MALL_ID = #mallId#
    </delete>
    
    <delete id="deleteRanking" parameterClass="map">
       DELETE FROM  TB_CATEGORY_DISPLAY_ENTITY 
       WHERE        DISP_MSTR_ID = #dispMstrId#
                    AND DGR != #newDgr#
                    AND MALL_ID = #mallId#
    </delete>
    
    <!-- 
        작성자 : 장진용
        작성일 : 13-01-28
        기능 : 인기 검색어 조회
    -->
    <select id="getTrendsKeyword" resultClass="searchKeywordData">
        /* RankingSQL.getTrendsKeyword */
       SELECT KEYWORD      keyword
            , RANKING      ranking
            , PREV_RANK    prevRank
            , REQUESTED    requested
         FROM TB_TRENDS_KEYWORD
        WHERE SEQ IN (SELECT MAX(SEQ) FROM TB_TRENDS_KEYWORD)
        ORDER BY RANKING
    </select>
    
    <!--  
        작성자: 장진용
        작성일 : 2015.05.12
        기능 : 추천 검색어 목록 반환  
    -->
    <select id="getKeywordPick" resultClass="searchKeywordData">
        /* RankingSQL.getKeywordPick */
        SELECT KEYWORD      keyword
             , RANKING      ranking
             , PREV_RANK    prevRank
          FROM TB_KEYWORD_PICK
         WHERE SEQ = (SELECT MAX(SEQ) FROM TB_KEYWORD_PICK)
           AND KEYWORD IS NOT NULL
         ORDER BY RANKING
    </select>
    
    
    <!--  
        작성자: 장진용
        작성일 : 2017.06.14
        기능 : 제안 검색어 목록 반환(추천과 달리 MD가 직접 관리)  
    -->
    <select id="getKeywordChoice" resultClass="searchKeywordData">
        /* RankingSQL.getKeywordChoice */
        SELECT KEYWORD      keyword
             , RANKING      ranking
             , PREV_RANK    prevRank
          FROM TB_KEYWORD_CHOICE
         WHERE SEQ = (SELECT MAX(SEQ) FROM TB_KEYWORD_CHOICE)
           AND KEYWORD IS NOT NULL
         ORDER BY RANKING
    </select>
    
    <!--  
        작성자: 장진용
        작성일 : 2015.06.15
        기능 : 인기  검색어 목록 반환  
    -->
    <select id="getKeywordBest" resultClass="searchKeywordData">
        /* RankingSQL.getKeywordBest */
        SELECT KEYWORD      keyword
             , RANKING      ranking
             , PREV_RANK    prevRank
          FROM TB_KEYWORD_BEST
         WHERE SEQ = (SELECT MAX(SEQ) FROM TB_KEYWORD_BEST)
           AND KEYWORD IS NOT NULL
         ORDER BY RANKING
    </select>
</sqlMap>
