<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BizPersonalSQL">
    <typeAlias alias="dispRecobellCriteria" type="kr.co.hottracks.site.model.common.disp.DispRecobellCriteria"/>
    <typeAlias alias="cartCriteria" type="kr.co.hottracks.site.model.frontoffice.order.CartCriteria"/>
    <typeAlias alias="dispCriteria" type="kr.co.hottracks.site.model.common.disp.DispCriteria"/>
    <typeAlias alias="wishProductParam" type="kr.co.hottracks.site.model.frontoffice.mypage.WishProductParam" />
    <typeAlias alias="criteria" type="kr.co.hottracks.site.model.frontoffice.mypage.WishProductCriteria" />
    <typeAlias alias="eventExt" type="kr.co.hottracks.site.model.renewal.event.EventExt" />
    
    <select id="getRecentKeyword" resultClass="kr.co.hottracks.site.model.search.RecentKeyword">
        /* BizPersonalSQL.getRecentKeyword */
        SELECT RK.RCNT_KEY_SEQ    rcntKeySeq
             , RK.KEYWORD         keyword
          FROM TB_RECENT_KEYWORD RK
         WHERE 1 = 1
           <isNotEmpty property="userNum">
               AND RK.USER_NUM = #userNum#
           </isNotEmpty>
           <isNotEmpty property="sesnHashKey">
               AND RK.USER_NUM IS NULL
               AND RK.SESN_HASH_KEY = #sesnHashKey#
           </isNotEmpty>
           <isEmpty property="userNum">
               <isEmpty property="sesnHashKey">
                   AND 1 != 1
               </isEmpty>
           </isEmpty>
         ORDER BY RK.REGST_DTM DESC
    </select>
    
    <select id="getRecobellCtgrFix" parameterClass="dispRecobellCriteria" resultClass="kr.co.hottracks.site.model.common.disp.DispPrdtExt">
    	/* BizPersonalSQL.getRecobellCtgrFix */
			SELECT ctgrId, ctgrNm
    		  FROM (
				<iterate property="sellPrdtBcode" conjunction="union all">
				     select #sellPrdtBcode[]# ctgrId, FC_GET_CATEGORY_NAME(#sellPrdtBcode[]#) ctgrNm from dual
				</iterate>
         		)
         	GROUP BY ctgrId, ctgrNm
    </select>
    
    <select id="selectCartProductList" parameterClass="cartCriteria" resultClass="kr.co.hottracks.site.model.common.disp.DispPrdtExt">
    	/* BizPersonalSQL.selectCartProductList */
        SELECT  A.sell_prdt_bcode   sellPrdtBcode
              , B.sell_prdt_gbn  sellPrdtGbn
              , FC_GET_PRODUCT_IMAGE_URL(C.sell_prdt_bcode) productImageUrl
              , C.prdt_name      prdtName
              , b.rcrd_cd rcrdCd
              , FC_GET_CPN_PRICE(A.SELL_PRDT_BCODE, #mallId#)   lastCpnPrice
              , B.PRDT_SELL_PRICE prdtSellPrice
              , H.rtng_code rtngCode
              , NVL(F.BRAND_ENG_NAME, F.BRAND_NAME)	brandEngName
	          , FC_GET_WISH_PRODUCT_COUNT(A.SELL_PRDT_BCODE, '02')	wishPrdtCnt
	          , FC_GET_PRODUCT_ICON_CODE(A.SELL_PRDT_BCODE, '02')		prdtIcon
	          , FC_GET_REVIEW_PRODUCT_COUNT(A.SELL_PRDT_BCODE, '02')	reviewCount
              , B.prdt_stat_code        prdtStatCode
              , FC_GET_FREE_DLVY_YN(A.SELL_PRDT_BCODE, '02')         	lastFreeDlvyYn
		      , B.COD_DLVY_AMT_YN           							codDlvyAmtYn
		      , FC_GET_DC_RATE_MALL(A.SELL_PRDT_BCODE, '02')         	lastDcRate
          FROM  tb_cart A
              , tb_sell_product B
              , tb_sell_product C
              , tb_vendor D
              , tb_vendor_contract E
              , TB_BRAND F 
              , tb_record H
            <isNotEmpty property="orderId">
              , tb_cart_selt_prdt G
            </isNotEmpty>
         WHERE  A.sell_prdt_bcode = B.sell_prdt_bcode
           AND  FC_GET_BARCODE(B.sell_prdt_bcode) = C.sell_prdt_bcode
           AND  C.dlvy_vndr_id = D.vndr_id
           AND  B.vndr_cntrt_id = E.vndr_cntrt_id
           AND  B.rcrd_cd = H.rcrd_cd(+)
           AND  B.BRAND_ID = F.BRAND_ID(+)
        <isNotEmpty property="orderId">
           AND  A.cart_seq = G.cart_seq
           AND  G.order_id = #orderId#
        </isNotEmpty>
        <isEmpty property="orderId">
           AND A.GROUPSELLYN is null
        </isEmpty>
        <isEmpty property="orderId" prepend="AND">
            B.sell_prdt_gbn <![CDATA[<>]]> 'C'
        </isEmpty>
        <isEmpty property="orderId" prepend="AND">
            B.sell_prdt_gbn <![CDATA[<>]]> 'F'
        </isEmpty>
        <isEqual property="userYn" compareValue="true" prepend="AND">
                A.user_num = #userNum# AND A.mall_id = #mallId#
        </isEqual>
        <isEqual property="userYn" compareValue="false" prepend="AND">
                A.user_num is null AND A.sesn_hash_key = #sesnHashKey#
        </isEqual>
        <isNotEmpty property="cartSeqList" prepend="AND">
                A.cart_seq IN 
           <iterate open="(" close=")" property="cartSeqList" conjunction=",">
                #cartSeqList[]#
           </iterate>
        </isNotEmpty>
         ORDER BY C.dlvy_vndr_id, A.cart_seq
    </select>
    
    <select id="getRecentProduct" resultClass="kr.co.hottracks.site.model.frontoffice.product.RecentProductExt" parameterClass="kr.co.hottracks.site.model.frontoffice.product.RecentProductCriteria">
        /* BizPersonalSQL.getRecentProduct */
        SELECT SP.SELL_PRDT_BCODE       sellPrdtBcode
             , FC_GET_PRODUCT_IMAGE_URL(SP.SELL_PRDT_BCODE)                             productImageUrl
             , FC_GET_PRDT_NAME(SP.SELL_PRDT_BCODE, '02')                               prdtName
             , (SELECT BRAND_NAME FROM TB_BRAND B WHERE B.BRAND_ID = SP.BRAND_ID)       brandName
             , (SELECT BRAND_ENG_NAME FROM TB_BRAND B WHERE B.BRAND_ID = SP.BRAND_ID)   brandEngName
             , SP.PRDT_SELL_PRICE       prdtSellPrice
             , FC_GET_CPN_PRICE(SP.SELL_PRDT_BCODE,'02')                                lastCpnPrice
             , SP.SELL_PRDT_GBN         sellPrdtGbn
             , R.RCRD_CD                rcrdCd
             , RP.REGST_DTM             regstDtm
             , FC_GET_DC_RATE_MALL(SP.SELL_PRDT_BCODE, '02')         	lastDcRate
          FROM TB_RECENT_PRODUCT RP
          JOIN TB_SELL_PRODUCT SP ON RP.SELL_PRDT_BCODE = SP.SELL_PRDT_BCODE
          LEFT JOIN TB_RECORD R ON SP.SELL_PRDT_BCODE = R.SELL_PRDT_BCODE
         WHERE RP.MALL_ID = #mallId#
           <isNotEmpty property="userNum">
               AND RP.USER_NUM = #userNum#
           </isNotEmpty>
           <isNotEmpty property="sesnHashKey">
               AND RP.USER_NUM IS NULL
               AND RP.SESN_HASH_KEY = #sesnHashKey#
           </isNotEmpty>
           <isEmpty property="userNum">
               <isEmpty property="sesnHashKey">
                   AND 1 != 1
               </isEmpty>
           </isEmpty>
         ORDER BY RP.REGST_DTM DESC
    </select>
    
    <select id="getDispPrdtFix" parameterClass="dispCriteria" resultClass="kr.co.hottracks.site.model.common.disp.DispPrdtExt">
        /* BizPersonalSQL.getDispPrdtFix */
        SELECT A.DISP_SEQ           dispSeq
             , A.DISP_MSTR_ID       dispMstrId
             , A.MALL_ID            mallId
             , A.CTGR_ID            ctgrId
             , A.GROUP_NUM          groupNum
             , A.DISP_ORDER         dispOrder
             , A.SELL_PRDT_BCODE    sellPrdtBcode
             , NVL(A.PRDT_NAME, B.PRDT_NAME)    prdtName
             , NVL(A.PRDT_DESC, B.PRVD_TITLE)   prdtDesc
             , A.DISP_YN            dispYn
             , A.REGST_DTM          regstDtm
             , A.REGST_ADMIN_ID     regstAdminId
             , B.PRDT_NAME          basePrdtName
             , B.PRVD_TITLE         basePrdtDesc
             , B.PRDT_SELL_PRICE    basePrdtSellPrice
             , B.RCRD_CD            rcrdCd
             , B.SELL_PRDT_GBN      sellPrdtGbn
             , B.NYO_SELL_BAN_YN    nyoSellBanYn
             , B.PRDT_STAT_CODE     prdtStatCode
             , C.ARTI_NAME          artiName
             , FC_GET_PRODUCT_IMAGE_URL(A.SELL_PRDT_BCODE)      productImageUrl
             , FC_GET_PRODUCT_IMAGE_URL2(A.SELL_PRDT_BCODE)     productImageUrl2
             , FC_GET_DC_PRICE(A.SELL_PRDT_BCODE, A.MALL_ID)    lastDcPrice
             , FC_GET_CPN_PRICE(A.SELL_PRDT_BCODE, A.MALL_ID)   lastCpnPrice
             , D.BRAND_ID           brandId
             , D.BRAND_NAME         brandName
             , NVL(D.BRAND_ENG_NAME, D.BRAND_NAME)              brandEngName
             , FC_GET_WISH_PRODUCT_COUNT(B.SELL_PRDT_BCODE, '02')   wishPrdtCnt
             , FC_GET_PRODUCT_ICON_CODE(B.SELL_PRDT_BCODE, '02')    prdtIcon
             , FC_GET_REVIEW_PRODUCT_COUNT(A.SELL_PRDT_BCODE, '02') reviewCount
             , FC_GET_DC_RATE_MALL(A.SELL_PRDT_BCODE, '02')         lastDcRate
          FROM TD_DISP_PRDT A
          JOIN TB_SELL_PRODUCT B ON A.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE AND B.PRMT_CODE = 'C0302' AND B.PRDT_STAT_CODE IN ('C0312', 'C0313')
          LEFT JOIN TB_RECORD C ON B.SELL_PRDT_BCODE = C.SELL_PRDT_BCODE
          LEFT JOIN TB_BRAND D ON B.BRAND_ID = D.BRAND_ID
         WHERE A.DISP_YN = 'Y'
           AND DISP_MSTR_ID = #dispMstrId#
           AND A.MALL_ID = #mallId#
           <isNotEmpty property="ctgrId" prepend="AND">
               A.CTGR_ID = #ctgrId#
           </isNotEmpty>
         ORDER BY A.DISP_MSTR_ID, A.DISP_ORDER, B.PRMT_DTM DESC
    </select>
    
    <select id="getListWishBrand" resultClass="wishProductParam" parameterClass="criteria">
        /*BizPersonalSQL.getListWishBrand*/
        SELECT WP.WISH_PRDT_SEQ         wishProductSequence
             , WP.BRAND_ID              brandId
             , FC_GET_PRODUCT_IMAGE_URL(MAX(SP.SELL_PRDT_BCODE))                                            productImageUrl
             , FC_GET_PRODUCT_IMAGE_URL2(MAX(SP.SELL_PRDT_BCODE))                                           productImageUrl2
             , (SELECT B.BRAND_NAME FROM TB_BRAND B WHERE B.BRAND_ID = WP.BRAND_ID)  brandKorName
          FROM TB_WISH_PRODUCT WP
          LEFT JOIN TB_SELL_PRODUCT SP ON WP.BRAND_ID = SP.BRAND_ID AND SP.PRMT_CODE = 'C0302' AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
         WHERE WP.WISH_GBN = 'B'
           AND WP.USER_NUM = #userNum#
           AND WP.MALL_ID = #mallId#
         GROUP BY WP.USER_NUM, WP.WISH_PRDT_SEQ, WP.BRAND_ID
         ORDER BY WP.WISH_PRDT_SEQ DESC
    </select>

    <select id="getRecobellEventList" resultClass="eventExt" parameterClass="dispRecobellCriteria">
        /* BizPersonalSQL.getRecobellEventList */
        SELECT A.EVENT_ID           eventId
             , B.IMAGE_URL          imageUrl
             , A.CTGR_ID            ctgrId
             , A.EVENT_TITLE        eventTitle
             , A.EVENT_DTL_CONT     eventDtlCont
             , A.EVENT_START_DT     eventStartDt
             , A.EVENT_END_DT       eventEndDt
             , A.EVENT_RANGE_INFO   eventRangeInfo
             , A.CULT_ZONE_YN    	cultZoneYn
             , A.DISP_DSCNT_RATE    stdDscntRate
          FROM TB_EVENT_MASTER A
          JOIN TB_EVENT_IMAGE B ON A.EVENT_ID = B.EVENT_ID AND B.EVENT_IMAGE_CODE = 'C0382'
          JOIN TB_MALL_EVENT C ON A.EVENT_ID = C.EVENT_ID AND C.MALL_ID = '02'
          JOIN (
                select rownum RK, AA 
                  from (
			           <iterate property="sellPrdtBcode" conjunction="union all">
			                select #sellPrdtBcode[]# AA from dual
			           </iterate>
                       )
               ) D on A.EVENT_ID = D.AA
         WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.EVENT_START_DT AND A.EVENT_END_DT
           AND A.EVENT_STAT_CODE = 'C0181'    /* 정상 */
           AND A.PRMT_CODE = 'C0374'          /* 승인완료 */
           AND A.DISP_YN = 'Y'
           AND FC_IS_VALID_EVENT(A.EVENT_ID, '02') = 'Y'
    </select>
    
    <select id="getListWishProduct" resultClass="kr.co.hottracks.site.model.common.disp.DispPrdtExt" parameterClass="criteria">
        /*BizPersonalSQL.getListWishProduct*/
        SELECT B.SELL_PRDT_BCODE    sellPrdtBcode
			, B.SELL_PRDT_GBN      sellPrdtGbn
			, FC_GET_PRODUCT_IMAGE_URL(B.SELL_PRDT_BCODE) prdtImgUrl
			, NVL(B.PRDT_NAME, FC_GET_PRDT_NAME(B.SELL_PRDT_BCODE , '02'))  prdtName
			, B.RCRD_CD   rcrdCd
			, FC_GET_CPN_PRICE(B.SELL_PRDT_BCODE, '02')   lastCpnPrice
			, B.PRDT_SELL_PRICE    prdtSellPrice
			, FC_GET_PRODUCT_IMAGE_URL(B.SELL_PRDT_BCODE)      productImageUrl
			, FC_GET_PRODUCT_IMAGE_URL2(B.SELL_PRDT_BCODE)     productImageUrl2
			, B.NYO_SELL_BAN_YN    nyoSellBanYn
			, FC_GET_REVIEW_PRODUCT_COUNT(B.SELL_PRDT_BCODE, '02') reviewCount
			, FC_GET_WISH_PRODUCT_COUNT(B.SELL_PRDT_BCODE, '02')   wishPrdtCnt
			, FC_GET_PRODUCT_ICON_CODE(B.SELL_PRDT_BCODE, '02')    prdtIcon
			, B.PRDT_SELL_PRICE    basePrdtSellPrice
			, FC_GET_CPN_PRICE(B.SELL_PRDT_BCODE, '02')   lastCpnPrice
			, B.PRDT_STAT_CODE     prdtStatCode
			, C.BRAND_ID brandId
			, NVL(C.BRAND_ENG_NAME, C.BRAND_NAME)                   brandName
			, FC_GET_DC_RATE_MALL(B.SELL_PRDT_BCODE, '02')         	lastDcRate
          FROM TB_WISH_PRODUCT A
          JOIN TB_SELL_PRODUCT B ON A.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE
          JOIN TB_BRAND C ON B.BRAND_ID = C.BRAND_ID
          LEFT JOIN TB_RECORD D ON B.RCRD_CD = D.RCRD_CD
        WHERE A.WISH_GBN = 'P'
          AND A.MALL_ID = #mallId# 
          AND A.USER_NUM = #userNum#
          AND FC_IS_VALID_PRODUCT(A.SELL_PRDT_BCODE, #mallId#) = 'Y'
        ORDER BY A.WISH_PRDT_SEQ DESC
    </select>
    
    <select id="getRecobellBrandList" parameterClass="dispRecobellCriteria" resultClass="kr.co.hottracks.site.model.common.disp.DispPrdtExt">
    	/* BizPersonalSQL.getRecobellBrandList */
		SELECT A.BRAND_ID brandId, A.BRAND_NAME brandName
		FROM TB_BRAND A
		JOIN (
                select rownum RK, AA 
                  from (
			           <iterate property="sellPrdtBcode" conjunction="union all">
			                select #sellPrdtBcode[]# AA from dual
			           </iterate>
                       )
               ) B on A.BRAND_ID = B.AA
    </select>
</sqlMap>
