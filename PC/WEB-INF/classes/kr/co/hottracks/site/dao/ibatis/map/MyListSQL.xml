<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="MyListSQL">
    <typeAlias alias="myList" type="kr.co.hottracks.site.model.frontoffice.mylist.MyList"/>
    <typeAlias alias="myListExt" type="kr.co.hottracks.site.model.frontoffice.mylist.MyListExt"/>
    <typeAlias alias="myListFolder" type="kr.co.hottracks.site.model.frontoffice.mylist.MyListFolder"/>
    <typeAlias alias="myListFolderExt" type="kr.co.hottracks.site.model.frontoffice.mylist.MyListFolderExt"/>
    

    <!-- 
        기능 : 마이 폴더 만들기
        작성자 : 박상수
        작성일 : 2011. 07. 25.
     -->
    <insert id="createMyFolder" parameterClass="myListFolder">
        <selectKey keyProperty="myListFolderSeq">
            select my_list_folder_seq.nextval from dual
        </selectKey>
            insert into tb_my_list_folder(my_list_folder_seq, user_num, mall_id, folder_code, folder_name, regst_dtm, mod_dtm, use_yn)
            values(#myListFolderSeq#, #userNum#, #mallId#, #folderCode#, #folderName#, sysdate, sysdate, #useYn#)
    </insert>
    
    <!-- 
       기능 : 마이 리스트 만들기
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <insert id="createMyList" parameterClass="myList">
        <selectKey keyProperty="myListSeq">
            select my_list_seq.nextval from dual
        </selectKey>
            insert into tb_my_list(my_list_seq, my_list_folder_seq, rcrd_cd, rec_arti_cd, trk_id, regst_dtm)
            values(#myListSeq#, #myListFolderSeq#, #rcrdCd#, #recArtiCd#, #trkId#, sysdate)
    </insert>
    
    
	<!-- 
		기능 : 마이 리스트 등록 유효성 체크를 위한 쿼리
		작성자 : 김기석
		작성일 : 2011.09.09
	-->
    <select id="getMyListForCheck" parameterClass="map" resultClass="myListExt">
        select
            a.my_list_seq as myListSeq
        from tb_my_list a
        <dynamic prepend="where">
            <isNotEmpty property="myListFolderSeq" removeFirstPrepend="true" prepend="and">
                a.my_list_folder_seq = #myListFolderSeq#
            </isNotEmpty>
            <isNotEmpty property="rcrdCd" removeFirstPrepend="true" prepend="and">
                a.rcrd_cd = #rcrdCd#
            </isNotEmpty>
            <isNotEmpty property="trkId" removeFirstPrepend="true" prepend="and">
                a.trk_id = #trkId#
            </isNotEmpty>
            <isNotEmpty property="recArtiCd" removeFirstPrepend="true" prepend="and">
                a.rec_arti_cd = #recArtiCd#
            </isNotEmpty>
        </dynamic>
    </select> 
    
    <!-- 
       기능 : 마이 리스트 반환
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <select id="getMyLists" parameterClass="map" resultClass="myListExt" remapResults="true"  >
        select a.rcrd_cd as rcrdCd
             , a.my_list_seq as myListSeq
             , b.rtng_code as rtngCode
             , b.arti_name as artiName
             , c.sell_prdt_bcode as sellPrdtBcode
             , c.sell_prdt_gbn as sellPrdtGbn
             , c.prdt_name as prdtName
             , d.maker_name as makerName
             <isEqual property="folderCode" compareValue="C0941">
                 , (select trk_name from tb_rec_track where rcrd_cd = c.rcrd_cd and rownum = 1) trkName
             </isEqual>
          from tb_my_list a
          JOIN TB_RECORD B ON B.RCRD_CD = A.RCRD_CD
          JOIN TB_SELL_PRODUCT C ON C.SELL_PRDT_BCODE = B.SELL_PRDT_BCODE
          JOIN TB_REC_MAKER D ON D.MAKER_CD = B.MAKER_CD
        where a.my_list_folder_seq = #folderSeq#
    </select>
    
    <!-- 
       기능 : 마이 리스트 갯수 반환
    -->
    <select id="getMyListCnt" parameterClass="map" resultClass="int">
         select
            count(*)
        from tb_my_list a
         <isEqual property="folderCode" compareValue="C0944">
             inner join (
             select 
                    a.arti_name,
                    b.*,
                    c.maker_name
                from tb_record a
                inner join tb_sell_product b on a.sell_prdt_bcode = b.sell_prdt_bcode
                inner join tb_rec_maker c on a.maker_cd = c.maker_cd
            ) c on a.rcrd_cd = c.rcrd_cd 
        </isEqual>
        <isEqual property="folderCode" compareValue="C0941">
             inner join (
             select 
                    a.arti_name,
                    b.*,
                    c.maker_name
                from tb_record a
                inner join tb_sell_product b on a.sell_prdt_bcode = b.sell_prdt_bcode
                inner join tb_rec_maker c on a.maker_cd = c.maker_cd
            ) c on a.rcrd_cd = c.rcrd_cd 
        </isEqual>
        <isEqual property="folderCode" compareValue="C0943">
            inner join (
            select 
                a.*,
                c.sell_prdt_bcode,
                c.prdt_name    
            from tb_rec_artist a
            inner join (
                select
                     rcrd_cd
                     , rec_arti_cd
                     , row_number() over(partition by rec_arti_cd order by rlse_dt, rcrd_cd) as rnum
                     , count(*) over (partition by rec_arti_cd) as rcnt
                     , sell_prdt_bcode
                 from tb_record
            ) b on b.rec_arti_cd = a.rec_arti_cd and b.rnum = b.rcnt
            inner join tb_sell_product c on b.sell_prdt_bcode = c.sell_prdt_bcode
        ) d on a.rec_arti_cd = d.rec_arti_cd
        </isEqual>
        <isEqual property="folderCode" compareValue="C0942">
            inner join 
            (
                select 
                    e.*
                    , b.arti_name
                    , c.title
                from tb_track e
                inner join tb_track_artist a on a.trk_id = e.trk_id
                inner join tb_artist b on b.arti_id = a.arti_id
                inner join tb_album c on c.abm_id = e.abm_id
            ) e on a.trk_id = e.trk_id
        </isEqual>
        where 
            a.my_list_folder_seq = #folderSeq#
    </select>
    
    <!-- 
       기능 : 마이 폴더 반환
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <select id="getMyFolder" parameterClass="map" resultClass="myListFolderExt">
        select
            a.my_list_folder_seq as myListFolderSeq, 
            a.user_num as userNum, 
            a.folder_code as folderCode, 
            a.folder_name as folderName, 
            a.regst_dtm as regstDtm, 
            a.mod_dtm as modDtm, 
            a.use_yn as useYn, 
            (select count(*) from tb_my_list t where t.my_list_folder_seq = a.my_list_folder_seq) as itemCnt 
        from tb_my_list_folder a
        where
            a.user_num = #userNum# and  
            a.mall_id = #mallId# 
            <isNotEmpty property="myListFolderSeq" prepend="and">
                a.my_list_folder_seq = #myListFolderSeq# 
            </isNotEmpty>
            <isNotEmpty property="folderCode" prepend="and">
                a.folder_code= #folderCode#
            </isNotEmpty>
	        and
	            a.use_yn = 'Y'
        order by a.my_list_folder_seq desc
    </select>
    
    <!-- 
       기능 : 마이 폴더 갯수 반환
    -->
    <select id="getMyFolderCnt" parameterClass="map" resultClass="int">
        select
            count(*)
        from tb_my_list_folder a
        where
            a.user_num = #userNum# and  
            a.mall_id = #mallId# 
            <isNotEmpty property="myListFolderSeq" prepend="and">
                a.my_list_folder_seq = #myListFolderSeq# 
            </isNotEmpty>
            <isNotEmpty property="folderCode" prepend="and">
                a.folder_code= #folderCode#
            </isNotEmpty>
	        and
	            a.use_yn = 'Y'
        order by a.my_list_folder_seq desc
    </select>
    
    <!-- 
       기능 : 마이 폴더 업데이트
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <update id="updateMyFolder" parameterClass="myListFolder">
        update tb_my_list_folder set
            <isNotEmpty property="folderName">
                 folder_name = #folderName#, 
            </isNotEmpty>
            <isNotEmpty property="useYn">
                  use_yn = #useYn#,
            </isNotEmpty>
            mod_dtm = sysdate
        where
            my_list_folder_seq = #myListFolderSeq#
    </update>
    
    <!-- 
       기능 : 마이 리스트 삭제
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <delete id="deleteMyList" parameterClass="int">
        delete from tb_my_list
        where
            my_list_seq = #myListSeq#
    </delete>
    
    <!-- 
       기능 : 마이 리스트 폴더 삭제
    -->
    <delete id="deleteMyListFolder" parameterClass="int">
        delete from tb_my_list_folder
        where
            my_list_folder_seq = #myListFolderSeq#
    </delete>
    
    <!-- 
       기능 : 마이 리스트 삭제
       작성자 : 박상수
       작성일 : 2011. 07. 25.
    -->
    <delete id="deleteMyListByFolderSeq" parameterClass="int">
        delete from tb_my_list
        where
            my_list_folder_seq = #myListFolderSeq#
    </delete>
    
</sqlMap>