<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="ThemeShopSQL">
    <typeAlias alias="themeShopMasterExt" type="kr.co.hottracks.site.model.common.display.ThemeShopMasterExt"/>
    <typeAlias alias="themeShopMaster" type="kr.co.hottracks.site.model.common.display.ThemeShopMaster"/>
    <typeAlias alias="themeShopProduct" type="kr.co.hottracks.site.model.common.display.ThemeShopProduct"/>
    <typeAlias alias="themeShopProductCriteria" type="kr.co.hottracks.site.model.common.display.ThemeShopProductCriteria"/>
    <typeAlias alias="themeShopProductExt" type="kr.co.hottracks.site.model.common.display.ThemeShopProductExt"/>
    <typeAlias alias="themeShopDisplay" type="kr.co.hottracks.site.model.common.display.ThemeShopDisplay"/>
    <typeAlias alias="themeShopDisplayExt" type="kr.co.hottracks.site.model.common.display.ThemeShopDisplayExt"/>
    
    <!--  
        작성자: 장진용
        작성일 : 2013.02.26
        기능 : 테마샵 카테고리 로드
    -->
    <select id="getThemeShopMaster" parameterClass="themeShopMaster" resultClass="themeShopMasterExt">
        SELECT THEME_ID         themeId
             , PARNT_THEME_ID   parntThemeId
             , THEME_NAME       themeName
             , THEME_IMG_URL    themeImgUrl
             , REGST_DTM        regstDtm
             , REGST_ADMIN_ID   regstAdminId
             , USE_YN           useYn
             , DISP_ORDER       dispOrder
             , DISP_YN          dispYn
             , (SELECT COUNT(1) FROM TB_THEME_SHOP_PRODUCT TSP WHERE TSP.THEME_ID LIKE TSM.THEME_ID || '%')    productCnt
          FROM TB_THEME_SHOP_MASTER TSM
         WHERE DISP_YN = 'Y'
          <isNotEmpty property="themeId" prepend="AND" removeFirstPrepend="true">
              THEME_ID  = #themeId#
          </isNotEmpty>
          <isNotEmpty property="parntThemeId" prepend="AND" removeFirstPrepend="true">
              PARNT_THEME_ID  = #parntThemeId#
          </isNotEmpty>
         ORDER BY DISP_ORDER
    </select>
    
    <!--  
        작성자: 장진용
        작성일 : 2013.03.06
        기능 : 테마샵 카테고리별 상품 로드
    -->
    <select id="getThemeShopProduct" parameterClass="themeShopProductCriteria" resultClass="themeShopProductExt">
        /* ThemeShopSQL.getThemeShopProduct */
        SELECT V.SELL_PRDT_BCODE                                    sellPrdtBcode
             , V.PRDT_NAME                                          prdtName
             , V.SELL_PRDT_GBN                                      sellPrdtGbn
             , V.PRDT_SELL_PRICE                                    prdtSellPrice
             , FC_GET_PRODUCT_IMAGE_URL(V.SELL_PRDT_BCODE)          productImageUrl
             , FC_GET_DC_PRICE(V.SELL_PRDT_BCODE, '02')             lastDcPrice
             , FC_GET_DC_RATE_MALL(V.SELL_PRDT_BCODE, '02')         lastDcRate
             , FC_GET_CPN_PRICE(V.SELL_PRDT_BCODE, '02')            lastCpnPrice
             , FC_GET_PRODUCT_ICON_CODE(V.SELL_PRDT_BCODE, '02')    icon
             , (SELECT BRAND_NAME FROM TB_BRAND B WHERE B.BRAND_ID = V.BRAND_ID)    brandName
             , NVL((SELECT COUNT(*) FROM TB_PRODUCT_QNA QNA WHERE MALL_ID = '02' AND PRDT_ARTCL_GBN   = 'C' AND DISP_YN = 'Y' AND OPEN_YN = 'Y' AND QNA.SELL_PRDT_BCODE  = V.SELL_PRDT_BCODE),0) reviewCnt 
             , listSize
          FROM (SELECT T.*
                     , ROWNUM NO
                     , SUM(CASE WHEN ROWNUM &lt; #topCount#+1 THEN 1 ELSE 0 END) OVER() listSize
                  FROM (
                    SELECT DP.SELL_PRDT_BCODE
                         , DP.PRDT_NAME
                         , DP.BRAND_ID
                         , DP.PRDT_SELL_PRICE
                         , DP.SELL_PRDT_GBN
                         , DP.PRDT_STAT_CODE
                      FROM TB_DISPLAY_PRODUCT DP
                      LEFT JOIN TB_DISPLAY_PRODUCT_SALE DPS ON DP.SELL_PRDT_BCODE = DPS.SELL_PRDT_BCODE AND DPS.MALL_ID = '02'
                     WHERE DP.SELL_PRDT_GBN IN ('P', 'G')
                       AND DP.PRDT_STAT_CODE IN ('C0312', 'C0313')
                       AND EXISTS (SELECT * FROM TB_THEME_SHOP_PRODUCT TSP WHERE TSP.SELL_PRDT_BCODE = DP.SELL_PRDT_BCODE AND TSP.THEME_ID LIKE '000001'||'%') 
                    <dynamic prepend="ORDER BY">
                        <!-- R:최신순, P:인기순, L:낮은가격순, H:높은가격순 -->
                        <isEmpty property="orderBy">DP.PRMT_DTM DESC</isEmpty>
                        <isNotEmpty property="orderBy">
                            <isEqual property="orderBy" compareValue="R">DP.PRMT_DTM DESC</isEqual>
                            <isEqual property="orderBy" compareValue="P">NVL(DPS.SALE_CNT, 0) DESC, DP.PRMT_DTM DESC</isEqual>
                            <isEqual property="orderBy" compareValue="L">FC_GET_CPN_PRICE(DP.SELL_PRDT_BCODE, '02') ASC, DP.PRMT_DTM DESC</isEqual>
                            <isEqual property="orderBy" compareValue="H">FC_GET_CPN_PRICE(DP.SELL_PRDT_BCODE, '02') DESC, DP.PRMT_DTM DESC</isEqual>
                        </isNotEmpty>
                    </dynamic>
                  ) T
              ) V
         WHERE NO BETWEEN #fetchScale# + 1 AND #maxRownum#
         ORDER BY NO
    </select>
    
    <!-- ===================================================== 메인 전시===================================================== -->
    <!-- 
        작성자 : 장진용
        작성일 : 2012-01-05
        기능 : 메인 전시 배너를 반환한다.
    -->
    <select id="getThemeShopDisplay" parameterClass="themeShopDisplay" resultClass="themeShopDisplayExt">
        SELECT TSD.DISP_ETT_SEQ         dispEttSeq
             , TSD.DISP_MSTR_ID         dispMstrId
             , TSD.THEME_ID             themeId
             , TSD.ETT_GBN              ettGbn
             , TSD.DISP_ORDER           dispOrder
             , TSD.GROUP_ID             groupId
             , TSD.BNR_SEQ              bnrSeq
             , TSD.IMAGE_URL            imageUrl
             , TSD.SELL_PRDT_BCODE      sellPrdtBcode
             , TSD.DISP_YN              dispYn
             , TSD.MALL_ID              mallId
             , TSD.BNR_SIZE_CODE        bnrSizeCode
             , TSD.DISP_TITLE           dispTitle
             , TSD.REGST_ADMIN_ID       regstAdminId
             , TSD.REGST_DTM            regstDtm
             , FC_GET_CODE_NAME(TSD.BNR_SIZE_CODE)              bnrSizeCodeName
             , BM.IMAGE_URL             bnrImageUrl
             , BM.NEW_WDW_YN            bnrNewWdwYn
             , BM.BNR_TGT_GBN           bnrTgtGbn
             , BM.BNR_LINK_URL          bnrLinkUrl
             , SP.PRDT_NAME             prdtName
             , SP.SELL_PRDT_GBN         sellPrdtGbn
             , SP.RCRD_CD               rcrdCd
             , FC_GET_PRODUCT_IMAGE_URL(SP.SELL_PRDT_BCODE)     prdtImageUrl
             , FC_GET_CPN_PRICE(SP.SELL_PRDT_BCODE, '02')       lastCpnPrice
          FROM TB_THEME_SHOP_DISPLAY TSD
          LEFT OUTER JOIN TB_BANNER_MASTER BM ON BM.BNR_SEQ = TSD.BNR_SEQ
          LEFT OUTER JOIN TB_SELL_PRODUCT SP ON SP.SELL_PRDT_BCODE = TSD.SELL_PRDT_BCODE AND SP.PRMT_CODE = 'C0302' AND SP.PRDT_STAT_CODE IN ('C0312', 'C0313')
         WHERE TSD.THEME_ID = #themeId#
           AND TSD.DISP_MSTR_ID = #dispMstrId#
           AND ((TSD.ETT_GBN = 'N' AND TSD.BNR_SEQ IS NOT NULL) OR (TSD.ETT_GBN = 'P' AND (SP.SELL_PRDT_BCODE IS NOT NULL OR TSD.DISP_TITLE IS NOT NULL)))
         ORDER BY TSD.DISP_MSTR_ID, TSD.GROUP_ID, TSD.DISP_ORDER
    </select>
</sqlMap>