<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="RecordBestSQL">
    <typeAlias alias="recordBestCriteria" type="kr.co.hottracks.site.model.common.record.RecordBestCriteria"/>
    <typeAlias alias="recordProductExt" type="kr.co.hottracks.site.model.common.record.RecordProductExt"/>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.15
        기능 : 
            지정한 날짜의 주간 정보를 반환한다.
        - 월요일기준이며 해당월의 첫번째 월요일이 1주가 됨.
    -->
    <select id="getWeekByMonth" parameterClass="string" resultClass="string">
        SELECT WEEK
          FROM (select to_char(dt,'yyyymmdd') as dt
                     , to_char(dt,'yyyymm') || '0' || dense_rank() over(order by trunc(dt,'d')) as week
                  from (select *
                          from (select to_date(sdt,'yyyymmdd') + level - 1 dt
                                  from (select substr(#value#, 0, 6) || '01' sdt, to_char(last_day(to_date(#value#,'yyyymmdd')),'yyyymmdd') edt from dual)
                               connect by level &lt;= to_date(edt,'yyyymmdd') - to_date(sdt,'yyyymmdd') + 1
                               )
                         WHERE TO_CHAR(TRUNC(DT,'d'),'mm') &gt;= TO_CHAR(DT,'mm')
                       )
               )
         WHERE DT = #value#
    </select>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품 정보 반환 - 공통조건절
    -->
    <sql id="getRecordBestWhere">
        <dynamic prepend="where">
            <isGreaterThan property="maxRank" compareValue="0" removeFirstPrepend="true" prepend="and">
                a.rank &lt;= #maxRank#
            </isGreaterThan>        
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="stdDt" removeFirstPrepend="true" prepend="and">
                a.std_dt = #stdDt#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>            
        </dynamic>
    </sql>
    
    
    <!--
        작성자 : 김기석
        작성일 : 2011.11.21
        기능 : 
            음반 카테고리별 쇼 케이스 목록을 처리하기 위한 쿼리
            - 데이터의 양을 최소화함.
    -->
    <select id="getRecordBestListSmall" parameterClass="recordBestCriteria" resultClass="recordProductExt">
        select
            a.rank, 
            b.sell_prdt_bcode as sellPrdtBcode, 
            nvl(b.prvd_title, c.rcrd_name) as commTitle, 
            c.arti_name as artiName 
        from 
            (
            select
                a.rcrd_cd, 
                a.rank
            from tb_record_best a
            <include refid="getRecordBestWhere"/>
        ) a
        inner join tb_record c on a.rcrd_cd = c.rcrd_cd
        inner join tb_sell_product b on b.sell_prdt_bcode = c.sell_prdt_bcode and b.sell_prdt_bcode not in (SELECT SELL_PRDT_BCODE FROM TB_EXP_PRODUCT) 
        order by a.rank
    </select>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품 정보 반환
            - 모든 베스트상품 목록은 여기에서 공통으로 처리
            - 성능이슈로 캐쉬모델을 사용함.
             cacheModel="getRecordBestChache"
    -->
    <cacheModel type="LRU" id="getRecordBestChache" readOnly="true">
        <flushInterval minutes="10"/>
        <property name="size" value="3000"/>
    </cacheModel>    
    <select id="getRecordBest" parameterClass="recordBestCriteria" resultClass="recordProductExt">
        select
            a.rank, 
            a.rcrd_cd as rcrdCd, 
            b.sell_prdt_bcode as sellPrdtBcode, 
            b.prvd_title as prvdTitle,  
            CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') &lt;= b.SUB_COMMENTS_END_DT THEN b.RCRD_SUB_COMMENTS END as rcrdSubComments,  
            b.sell_prdt_gbn as sellPrdtGbn,   
            c.rcrd_name as rcrdName, 
            nvl(b.prvd_title, c.rcrd_name) as commTitle, 
            c.arti_name as artiName, 
            (select t.maker_name from tb_rec_maker t where t.maker_cd = c.maker_cd) as makerName, 
            (select t.label_name from tb_rec_label t where t.label_cd = c.label_cd) as labelName,   /* 레이블명 */
            c.rlse_dt as rlseDt, 
            fc_rec_get_sale_yn(d.stock_cnt_product, b.rcrd_stat, b.rcrd_hard_sale_yn, b.rcrd_lsale_start_dth, b.rcrd_lsale_end_dth, b.lave_count) as saleYn, 
            fc_rec_get_stock_mail_yn(d.stock_cnt_product, b.rcrd_stat, b.rcrd_hard_sale_yn, b.rcrd_lsale_start_dth, b.rcrd_lsale_end_dth) as outOfStockMailYn, 
            b.prdt_sell_price as prdtSellPrice, 
            fc_get_dc_price(b.sell_prdt_bcode,'02') as priceReal, 
            b.prdt_saved_rate as prdtSavedRate,
            b.prdt_dscnt_rate as prdtDscntRate,
            c.rlse_dt as rlseDt,
            b.rcrd_stat as rcrdStat, 
            b.free_dlvy_yn as freeDlvyYn, 
            c.imp_yn as impYn, 
            b.rcrd_rlse_info as rcrdRlseInfo,
            a.regst_dtm regstDtm, 
            c.rtng_code as ratingCode,                                                               /* 연령 등급 코드 */
            /* (select substr(t1.rcrd_desc, 0, 100) from tb_rec_desc t1 where t1.rcrd_cd = a.rcrd_cd) as description,*/ 
            fc_rec_get_review_count(a.rcrd_cd) as reviewCount,
            fc_rec_get_review_grade(a.rcrd_cd) as reviewGrade            
        from tb_record_best a
        inner join tb_record c on a.rcrd_cd = c.rcrd_cd
        inner join tb_sell_product b on b.sell_prdt_bcode = c.sell_prdt_bcode and b.sell_prdt_bcode not in (SELECT SELL_PRDT_BCODE FROM TB_EXP_PRODUCT)
        inner join tb_rec_prod_stock_last d on b.sell_prdt_bcode = d.sell_prdt_bcode
        <include refid="getRecordBestWhere"/>
        order by a.rank
    </select>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품 정보 목록 개수 반환
    -->
    <select id="getRecordBestListCount" parameterClass="recordBestCriteria" resultClass="int">
        select
            count(*) as cnt  
        from 
            (
            select
                a.rcrd_cd
            from tb_record_best a
            <include refid="getRecordBestWhere"/>
        ) a
        where
            rownum <![CDATA[ < ]]> #topCount# + 1
    </select>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품의 최종 기준일자 정보를 반환함.
            - 최종 업데이트 기준일자를 획득하기 위해서 사용함.
    -->    
    <select id="getRecordBestLastStdDt" parameterClass="recordBestCriteria" resultClass="string">
        select
            max(a.std_dt)
        from tb_record_best a
        <dynamic prepend="where">
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>            
        </dynamic>
    </select>
    
    <select id="getRecordBestNextStdDt" parameterClass="recordBestCriteria" resultClass="string">
        select
            min(a.std_dt)
        from tb_record_best a
        <dynamic prepend="where">
            <isNotEmpty property="stdDt" removeFirstPrepend="true" prepend="and">
                a.std_dt > #stdDt#
            </isNotEmpty>
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>
        </dynamic>
    </select>
    
    <select id="getRecordBestPrevStdDt" parameterClass="recordBestCriteria" resultClass="string">
        select
            max(a.std_dt)
        from tb_record_best a
        <dynamic prepend="where">
            <isNotEmpty property="stdDt" removeFirstPrepend="true" prepend="and">
                a.std_dt &lt; #stdDt#
            </isNotEmpty>
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>
        </dynamic>    
    </select>
    
    <!-- 
        베스트 상품의 최초 기준일자 정보를 반환함.
        - 최초 업데이트 기준일자를 획득하기 위해서 사용함.
     -->
    <select id="getRecordBestFirstStdDt" parameterClass="recordBestCriteria" resultClass="string">
        select
            min(a.std_dt)
        from tb_record_best a
        <dynamic prepend="where">
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>
        </dynamic>
    </select>
    
    <!-- 
        작성일: 2016-02-15
        작성자: 장진용
        기능: 주차로부터 시작일과 종료일 반환
     -->
    <select id="getDateScopeFromWeek" parameterClass="string" resultClass="kr.co.hottracks.site.model.common.record.RecordBestExt">
        /* RecordBestSQL.getDateScopeFromWeek */
        SELECT SDT  startDate
             , EDT  endDate
          FROM (
        SELECT TO_CHAR(TRUNC(DT, 'IW'), 'YYYYMM') || LPAD(TO_CHAR(TRUNC(DT, 'IW'), 'W'), 2, '0') WEEK
             , TRUNC(DT, 'IW')      SDT
             , TRUNC(DT, 'IW')+6    EDT
          FROM (SELECT TO_DATE(SDT,'YYYYMMDD') + LEVEL - 1 DT
                  FROM (SELECT '19000101' SDT, TO_CHAR(LAST_DAY(TO_DATE('29991201','YYYYMMDD')),'YYYYMMDD') EDT FROM DUAL)
               CONNECT BY LEVEL &lt;= TO_DATE(EDT,'YYYYMMDD') - TO_DATE(SDT,'YYYYMMDD') + 1
               )
               )
         WHERE WEEK = #value#
         GROUP BY WEEK, SDT, EDT
    </select>
    
</sqlMap>