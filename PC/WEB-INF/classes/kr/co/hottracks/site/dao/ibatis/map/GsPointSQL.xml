<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="GsPointSQL">
    <typeAlias alias="gsPointParam" type="kr.co.hottracks.site.model.frontoffice.order.GsPointParam"/>

    <select id="getgsPointOrderUse" parameterClass="gsPointParam" resultClass="gsPointParam">
		select USER_NUM  userNum
		     , GSAMT     gsPoint
		     , ORDER_NUM  orderNum
		     , GSID  gsId
		     , GSAPPROVDT  appprovdate
		     , GSAPPROVNO  approvno
		     , to_char(sysdate,'yyyymmdd') transDt
		     , to_char(sysdate,'HH24MISS') transTm
		     , GSCARDNO gsCardNum
		  from TB_GSPOINT
		 where USER_NUM = #userNum#
		   and ORDER_NUM = #orderNum#
		   and CHNG_RES = '01'
    </select>

    <parameterMap id="gsPointSaveInput" class="java.util.Map">
        <parameter property="V_ORDERNUM" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
        <parameter property="V_CARDNO" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
    </parameterMap>

    <procedure id="gsPointSave" parameterMap="gsPointSaveInput">
        { call PR_GSPPOINTSAVE(?,?) }
    </procedure>

    <select id="getgsPointSaveList" resultClass="gsPointParam">
		select A.USER_NUM   userNum
		     , A.SEQ    seq
		     , A.CHNG_DT    chngdt
		     , A.CHNG_RES   chngres
		     , nvl(A.GSAMT,0)      gsamt
		     , A.ORDER_NUM  orderNum
		     , A.ORDER_PRDT_INSEQ   orderPrdtInseq
		     , A.GSAPPROVDT appprovdate
		     , A.GSAPPROVNO approvno
		     , A.GSCARDNO   gsCardNum
		     , (select B.PRDT_GSAMT from TB_GSORDER B where B.ORDER_NUM = A.ORDER_NUM and B.ORDER_PRDT_INSEQ = A.ORDER_PRDT_INSEQ) gsPoint
		     , nvl(A.GSONEAMT,0)   oneAmt
		  from TB_GSPOINT A
		     , TB_ORDER_DELIVERY_PRODUCT C
		     , TB_DELIVERY D
		 where A.CHNG_RES in ('03','04')
		   and A.GSYN = 'N'
		   and A.ORDER_NUM = C.ORDER_NUM
		   and A.ORDER_PRDT_INSEQ = C.ORDER_PRDT_INSEQ
		   and C.DLVY_ID = D.DLVY_ID
		   and A.GSAMT != 0
		   and D.CCL_YN = 'Y'
		   and D.DLVY_GBN_CODE = 'C0131'
    </select>

    <update id="getgsPointSaveSuccess" parameterClass="gsPointParam">
		update TB_GSPOINT
		   set GSAPPROVDT = #appprovdate#
		     , GSAPPROVNO = #approvno#
		     , GSYN = 'Y'
		     , GSDT = to_char(sysdate,'yyyymmdd')
		     , GSONEAMT = #gsamt#
		 where USER_NUM = #userNum#
		   and SEQ = #seq#
    </update>
    
    <parameterMap id="changePointSaveInput" class="java.util.Map">
        <parameter property="V_ORDERNUM" javaType="java.lang.String" jdbcType="VARCHAR" mode="IN" />
    </parameterMap>

    <procedure id="changePointSave" parameterMap="changePointSaveInput">
        { call PR_GSPPOINTSAVECHANGE(?) }
    </procedure>
    
    
    <select id="getGsPointList" parameterClass="gsPointParam" resultClass="gsPointParam">
		select GSDT dt
		     , sum(case when CHNG_RES = '01' then 1 else 0 end) useCnt
		     , sum(case when CHNG_RES = '01' then GSAMT else 0 end) useAmt
		     , sum(case when CHNG_RES = '02' then 1 else 0 end) useCancleCnt
		     , sum(case when CHNG_RES = '02' then GSAMT else 0 end) useCancleAmt
		     , sum(case when CHNG_RES = '03' then 1 else 0 end) saveCnt
		     , sum(case when CHNG_RES = '03' then GSAMT else 0 end) saveAmt
		     , sum(case when CHNG_RES = '04' then 1 else 0 end) saveCancleCnt
		     , sum(case when CHNG_RES = '04' then GSAMT else 0 end) saveCancleAmt
		  from TB_GSPOINT
		 where GSDT between #startDate# and #endDate#
		   and GSYN = 'Y'
		 group by GSDT
		 order by GSDT
    </select>
    
    <select id="fnGsPointSaveCancle" resultClass="gsPointParam">
        select TEMP1 chngdt
             , TEMP2 approvno
             , TEMP3 gsCardNum
             , TEMP4 saveAmt
             , TEMP5 saveCancleAmt
             , TEMP6 remark
          from TEMPER
    </select>
    
    <update id="setGsSaveSuccess" parameterClass="gsPointParam">
        update TEMPER
           set TEMP7 = 'Y'
         where TEMP2 = #approvno#
    </update>
    
    <select id="fnGetDreamList" resultClass="gsPointParam">
		select TEMP1  result
		     , TEMP13 remark
		     , TEMP14 orderNum
		     , TEMP15 gsCardNum
		  from temper_dream
		 where (SUCCYN != 'Y' or SUCCYN is null)  
    </select>
    
    <update id="setImageUrl1" parameterClass="gsPointParam">
        update temper_dream
           set IMGURL1 = #chngdt#
         where TEMP1 = #result#
    </update>
    
    <update id="setImageUrl2" parameterClass="gsPointParam">
        update temper_dream
           set IMGURL2 = #chngres#
         where TEMP1 = #result#
    </update>
    
    <update id="setImageUrl3" parameterClass="gsPointParam">
        update temper_dream
           set IMGURL3 = #gsId#
         where TEMP1 = #result#
    </update>

    <update id="setDesc" parameterClass="gsPointParam">
        update temper_dream
           set GOODDESC2 = #endDate#
             , SUCCYN = 'Y'
         where TEMP1 = #result#
    </update>
    
</sqlMap>