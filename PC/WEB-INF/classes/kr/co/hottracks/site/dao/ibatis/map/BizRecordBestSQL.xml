<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="BizRecordBestSQL">
	<typeAlias alias="RecordBestCriteria" type="kr.co.hottracks.site.model.common.record.RecordBestCriteria"/>
    <typeAlias alias="RecordProductExt" type="kr.co.hottracks.site.model.common.record.RecordProductExt"/>
    <typeAlias alias="bizRecordBestCriteria" type="kr.co.hottracks.site.model.common.record.BizRecordBestCriteria"/>
    <typeAlias alias="bizRecordProductExt" type="kr.co.hottracks.site.model.common.record.BizRecordProductExt"/>
 
 
     <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품 정보 반환 - 공통조건절
    -->
    <sql id="getRecordBestWhere">
        <dynamic prepend="where">
            <isGreaterThan property="maxRank" compareValue="0" removeFirstPrepend="true" prepend="and">
                a.rank &lt;= #maxRank#
            </isGreaterThan>        
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="stdDt" removeFirstPrepend="true" prepend="and">
                a.std_dt = #stdDt#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>            
        </dynamic>
    </sql>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품 정보 반환            
    -->    
    <select id="getRecordBest" parameterClass="bizRecordBestCriteria" resultClass="bizRecordProductExt">
    	/* BizRecordBestSQL.getRecordBest */
        select
            a.rank, 
            a.rcrd_cd as rcrdCd, 
            b.sell_prdt_bcode as sellPrdtBcode, 
            b.prvd_title as prvdTitle,  
            CASE WHEN TO_CHAR(SYSDATE, 'YYYYMMDD') &lt;= b.SUB_COMMENTS_END_DT THEN b.RCRD_SUB_COMMENTS END as rcrdSubComments,  
            b.sell_prdt_gbn as sellPrdtGbn,   
            c.rcrd_name as rcrdName, 
            nvl(b.prvd_title, c.rcrd_name) as commTitle, 
            c.arti_name as artiName, 
            (select t.maker_name from tb_rec_maker t where t.maker_cd = c.maker_cd) as makerName, 
            (select t.label_name from tb_rec_label t where t.label_cd = c.label_cd) as labelName,   /* 레이블명 */
            c.rlse_dt as rlseDt, 
            fc_rec_get_sale_yn(d.stock_cnt_product, b.rcrd_stat, b.rcrd_hard_sale_yn, b.rcrd_lsale_start_dth, b.rcrd_lsale_end_dth, b.lave_count) as saleYn, 
            fc_rec_get_stock_mail_yn(d.stock_cnt_product, b.rcrd_stat, b.rcrd_hard_sale_yn, b.rcrd_lsale_start_dth, b.rcrd_lsale_end_dth) as outOfStockMailYn, 
            b.prdt_sell_price as prdtSellPrice, 
            fc_get_dc_price(b.sell_prdt_bcode,'02') as priceReal, 
            b.prdt_saved_rate as prdtSavedRate,
            b.prdt_dscnt_rate as prdtDscntRate,
            c.rlse_dt as rlseDt,
            b.rcrd_stat as rcrdStat, 
            b.free_dlvy_yn as freeDlvyYn, 
            c.imp_yn as impYn, 
            b.rcrd_rlse_info as rcrdRlseInfo,
            a.regst_dtm regstDtm, 
            c.rtng_code as ratingCode,                                                               /* 연령 등급 코드 */
            /* (select substr(t1.rcrd_desc, 0, 100) from tb_rec_desc t1 where t1.rcrd_cd = a.rcrd_cd) as description,*/ 
            fc_rec_get_review_count(a.rcrd_cd) as reviewCount,
            fc_rec_get_review_grade(a.rcrd_cd) as reviewGrade,            
            nvl((SELECT COUNT(1) FROM TB_WISH_PRODUCT TP WHERE TP.WISH_GBN = 'P' AND TP.SELL_PRDT_BCODE =  b.SELL_PRDT_BCODE AND TP.MALL_ID = '02' AND TP.USER_NUM = #userNum#), 0) as wishUserPrdtCnt,
            FC_GET_PRODUCT_ICON_CODE(b.SELL_PRDT_BCODE, '02') as prdtIcon,
            DECODE((SELECT COUNT(*) FROM TB_POSTER_CASE PC WHERE TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN PC.PRSNT_START_DAY AND PRSNT_END_DAY AND PC.SELL_PRDT_BCODE = b.SELL_PRDT_BCODE), '0', 'N', 'Y') as hasPosterCaseYn,
            rm.media_name as mediaName,
            a.ctgr_id as ctgrId                        
        from tb_record_best a
        inner join tb_record c on a.rcrd_cd = c.rcrd_cd
        inner join tb_sell_product b on b.sell_prdt_bcode = c.sell_prdt_bcode and b.sell_prdt_bcode not in (SELECT SELL_PRDT_BCODE FROM TB_EXP_PRODUCT)
        inner join tb_rec_prod_stock_last d on b.sell_prdt_bcode = d.sell_prdt_bcode
        left outer join tb_rec_media rm on c.media_cd = rm.media_cd        
        <include refid="getRecordBestWhere"/>
        order by a.rank
    </select>
    
    <!--
        작성자 : 김기석
        작성일 : 2011.09.19
        기능 : 
            베스트 상품의 최종 기준일자 정보를 반환함.
            - 최종 업데이트 기준일자를 획득하기 위해서 사용함.
    -->    
    <select id="getRecordBestLastStdDt" parameterClass="recordBestCriteria" resultClass="string">
        select
            max(a.std_dt)
        from tb_record_best a
        <dynamic prepend="where">
            <isNotEmpty property="recBestType" removeFirstPrepend="true" prepend="and">
                a.rec_best_type = #recBestType#
            </isNotEmpty>
            <isNotEmpty property="bestRangeType" removeFirstPrepend="true" prepend="and">
                a.best_range_type = #bestRangeType#
            </isNotEmpty>
            <isNotEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id = #ctgrId#
            </isNotEmpty>
            <isEmpty property="ctgrId" removeFirstPrepend="true" prepend="and">
                a.ctgr_id is null
            </isEmpty>            
        </dynamic>
    </select>    
    
</sqlMap>